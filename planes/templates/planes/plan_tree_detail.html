{% extends "base.html" %}
{% load humanize %}

{% block topbar %}

{% include "planes/menu.html" %}

{% endblock %}

{% block username %}
	Bienvenido {{ full_name }} !
{% endblock %}

{% block sidebar %}
<!-- Menu general -->
<div class="pure-menu pure-menu-open">
    <a class="pure-menu-heading">M&oacute;dulos</a>
    <ul>
        <li><a href="{% url 'planes:plan_detail' plan.id %}">Volver</a></li>
    </ul>
</div>
<p></p>
<!-- Menu general -->
<form class="pure-form pure-form" id="save_form" method="post" action="/planes/plan/savestage1/">
    {% csrf_token %}
    <input id="input_json_data" type="hidden" name="plan" value="" />
</form>
<!-- Menu de acciones -->
<div class="pure-menu pure-menu-open">
    <a class="pure-menu-heading">Acciones</a>
    <ul>
        <li><a id="btnExpand">Expandir Nodos</a></li>
        <li><a id="btnCollapse">Collapsar Nodos</a></li>
        <li><a id="btnSave">Guardar &Aacute;rbol</a></li>
    </ul>
</div>        
<!-- Menu de acciones -->
{% endblock %}

{% block content %}
<h3>Arbol de Planificaci&oacute;n</h3>
<div style="width:50%; float:left">
    <div id="itemstree">
        <ul id="treeData" style="display: none;">
            {% for obj in items %}
            <li id="{{ obj.id }}" class="folder lazy"><a href="{% url 'categorias:categoria_detail' obj.id %}" target="_self">{{ obj.nombre }}</a>
            {% endfor %}
        </ul>
    </div>
</div>
<div style="width:45%; float:left; padding-left:10px;">
    <form class="pure-form pure-form" id="save_form" method="post" action="/planes/plan/savestage1/">
        {% csrf_token %}
        <input id="input_json_data" type="hidden" name="plan" value="" />
    </form>
    <div style="clear:both;">
        <div class="msg_info">
            <p id="msg_total"></p>
            <p id="msg_visibles"></p>
            <p id="msg_nodo_activo"></p>
        </div>
        {% if plan.estado == 1 %}
            <div class="msg_warning">
                <p>Cuidado:</p> Este árbol ya ha sido definido. Si presiona el botón guardar, reemplazará permanentemente la versión anterior.
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block js %}
<script>

$(function() {

    // Contar nodos a planificar (visibles)
    function definirVisibles(){
        var nodos_visibles = 0;
        $("#itemstree").fancytree("getTree").visit(function(node){
            if(!(typeof node.extraClasses == "undefined") && (node.extraClasses == "planificable")){
                if (node.isVisible()){
                    if (node.hasChildren()){
                        if (!node.isExpanded()){
                            nodos_visibles++;
                        }
                    }
                    else{
                        nodos_visibles++;
                    }
                    
                }
            }
            
        });
        $("#msg_visibles").html("<p>Items a planificar: " + nodos_visibles + "</p>");
        return false;
    }

    $("#itemstree").fancytree({
        
        lazyload: function(e, data){
        // return a source in 'data.result'
            data.result = {
            url: "{% url 'categorias:item_nodesearch' %}",
            data: {key: data.node.key}
            };
        },
        postProcess: function(event,data){
            //console.log(data);
        },
        expand: function(event, data){
            definirVisibles();
        },
        collapse: function(event, data){
            definirVisibles();
        },
        
    });

    $("#msg_visibles").html("<p>Items a planificar: 0</p>");

    // Expandir todos los nodos
    $("#btnExpand").click(function(){
        $("#itemstree").fancytree("getRootNode").visit(function(node){
            node.setExpanded(true);
        });
        return false;
    });

    $("#btnCollapse").click(function(){
        $("#itemstree").fancytree("getRootNode").visit(function(node){
            node.setExpanded(false);
        });
        return false;
    });

    /*var tree = $("#itemstree").fancytree("getTree");
    var num_nodos = tree.count();
    definirVisibles();
    $("#msg_total").html("<p>Total de ítems: " + num_nodos + "</p>");*/ 

    /*
        Enviar por POST dos campos, el ID del plan y un string de IDs de items
    */

    $("#btnSave").click(function(){
        var nodos_lista = [];
        var plan = parseInt({{plan.id}});
        /* Se obtiene la lista de ID de nodos que deben ser planificados/proyectados */
        $("#itemstree").fancytree("getTree").visit(function(node){
            if (node.isVisible()){                
                if(!(typeof node.extraClasses == "undefined") && (node.extraClasses == "planificable")){
                    if (node.hasChildren()){
                        if (!node.isExpanded()){
                            nodos_lista.push(parseInt(node.key));
                        }
                    }
                    else{
                        nodos_lista.push(parseInt(node.key));    
                    }
                }
                
            }
        });
        json_data = JSON.stringify({plan: plan,items: nodos_lista});
        $("#input_json_data").val(json_data);
        $("#save_form").submit();
    });
});

</script>

{% endblock %}

{% extends "base.html" %}

{% block topbar %}

{% include "planes/menu_plan_trabajo_detail.html" %}

{% endblock topbar %}

{% block username %}
	{{ full_name }}
{% endblock %}

{% block sidebar %}
<div class="pure-menu pure-menu-open">
    <a class="pure-menu-heading">Acciones</a>
    <ul>
        <li><a href="{% url 'planes:plan_detail' plan.id %}">Volver</a></li>
        <li class="pure-menu-disabled" id="panel-acciones"><a href="" id="btnSave">Guardar</a></li>
    </ul>
</div>

<!-- Seccion con parametros de busqueda del item a proyectar  -->
<div class="caja_bordes" style="padding: 0px 0px; float:left; width:100%;">
    <a class="caja-header">Proyecci&oacute;n</a>
    <table style="width:100%;">
        {% for categoria in combo_categorias %}
        <tr>
            <td><label>{{ categoria.nombre }}</label></td>
        </tr>
        <tr>
            <td>
                <select id="combo_cat_proy_{{ categoria.id }}" class="buscador">
                    <option value="-1" selected></option>
                    {% for item in items_categoria_raiz %}
                        {% if item.categoria = categoria %}
                        <option value="{{ item.id }}">{{ item.nombre }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </td>
        </tr>
        {% endfor %}
        <tr>
            <td><label>ITEMS</label></td>
        </tr>
        <tr>
            <td>
                <select id="combo_resultado" class="buscador">
                </select>
            </td>
        </tr>
    </table>
    <a class="caja-header">Comparativo</a>
    <table style="width:100%;">
        {% for categoria in combo_categorias_comp %}
        <tr>
            <td style="width:80%">
                <label>{{ categoria.nombre }}</label>
            </td>
            <td style="width:20%"></td>
        </tr>
        <tr>
            <td style="width:80%">
                <select id="combo_cat_comp_{{ categoria.id }}" class="buscador">
                    <option value="-1" selected></option>
                    {% for item in items_categoria_raiz %}
                        {% if item.categoria = categoria %}
                        <option value="{{ item.id }}">{{ item.nombre }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </td>
            <td style="width:20%">
                <button type="button" id="button_cat_comp_{{ categoria.id }}" class="pure-button pure-button-active" style="font-size: 70%;background: rgb(66, 184, 221);">></button>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>

<!-- Seccion con parametros de busqueda del item a proyectar  -->
{% endblock %}

{% block content %}
{% if msg %}
<h3>Proyectar Información</h3>
<div class="msg_warning">
    {{ msg }}
</div>
{% else %}

<div id="accordion">
    <h3>Item</h3>
    <div>
        <div id="tab_item_proyeccion">
            <div style="width:100%; float:left">
                <form id="form_proyeccion" class="pure-form">
                    {% csrf_token %}
                    <div id="tab_proyeccion" style="float:left; width:100%;">
                    </div>
                    <div style="float:left; width:100%;">
                    </div>
                    <div style="width:100%; float:left; padding-top:10px; padding-bottom:10px;">
                        <input id="json_data_proyeccion" type="hidden" name="proyeccion" value="" />
                    </div>
                </form>
                <div id="dialog-box" title="Proyección" style="text-align:center;">
                    <p id="dialog_help_msg"></p>
                    <input id="inputval" type="text" style="width:8em">
                </div>
            </div>
        </div>

        <div id="tab_item_planificacion_tv" style="display:none;">
            <div style="float:left; width:100%;">
                <div style="float:left; width:7%;">Precio Blanco:</div>
                <div id="itemprecio_blanco" class="editable" style="float:left; width:7%;"></div>
                <div style="float:left; width:7%; padding-left: 10px;">Costo Unitario:</div>
                <div id="itemcosto_unitario" class="editable" style="float:left; width:20%;"></div>
            </div>
            <div style="width:100%; float:left">
                <form id="form_planificacion-tv" class="pure-form">
                    {% csrf_token %}
                    <div style="width:100%; float:left;">
                        <div id="tab_planificacion_etiquetas" style="width:10%; float:left;">
                        </div>
                        <div id="tab_planificacion_datos" style="width:90%; float:left;">
                        </div>
                    </div>
                    <div style="width:100%; float:left; padding-top:10px; padding-bottom:10px;">
                        <input id="json_data_planificacion_tv" type="hidden" name="planificacion" value="" />
                    </div>
                </form>
            </div>
        </div>
    </div>
    <h3>Comparativo</h3>
    <div>
        <div id="tab_item_proyeccion_comp">
            <div id="item_proyeccion_comp"></div>
            <div style="width:100%; float:left">
                <div id="tab_comparativo" style="float:left; width:100%;">
                </div>
            </div>
        </div>
        <div id="tab_item_planificacion_tv_comp" style="display:none;">
            <div id="item_planificacion_tv_comp"></div>
            <div style="width:100%; float:left;">
                <div id="tab_comparativo_etiquetas" style="width:10%; float:left;">
                </div>
                <div id="tab_comparativo_datos" style="width:90%; float:left;">
                </div>
            </div>
        </div>    
    </div>
</div>
<div id="dvLoading" style="display:none;"></div>

{% endif%}

{% endblock %}

{% block js %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static "css/planes/proyeccion.css" %}">
<script src="{% static "planes/js/plan_trabajo_detail_proyeccion.js" %}" type="text/javascript"></script>
<script src="{% static "planes/js/plan_trabajo_detail_planificacion_tv.js" %}" type="text/javascript"></script>
<script>

$(function() {

    /*

    PARA CONTROLAR EL BOTON GUARDAR DE LA APLICACION

    if ( $("#panel-acciones").hasClass("pure-menu-disabled") )
        $("#panel-acciones").removeClass("pure-menu-disabled");
    */

    /*
    Objeto que mantiene informacion y principales estados del trabajo que el usuario
    se encuentra realizando en la pagina.
    */
    obj_trabajo = function(){
        // ID del item sobre el cual esta trabajando
        var id_item = null;
        /*
        Almacena la tarea que se esta realizando sobre la planificacion:
            - 1 Proyeccion (valor por defecto)
            - 2 Planificacion Temporada Vigente
            - 3 Planificacion Saldos y Avances
            - 4 Resumen
        */
        var actividad = 1;
        // ID de la planificacion sobre la cual se esta trabajando
        var id_plan = parseInt({{plan.id}});
        /*
        Almacena el estado del trabajo, es decir, si se han realizado modificaciones que deben ser guardadas:
            - false = no han habido modificaciones
            - true = ha sido modificada y los cambios no han sido guardados
        */
        var modificada = false;

        var proyeccion = null;
        var proyeccion_comp = null;

        var planificacion = null;
        var planificacion_comp = null;

        var celda_editada = null;
        
        function setItem(id){id_item = id;}
        function getItem(){return id_item;}
        
        function getPlan(){return id_plan;}

        function setModificada(estado){modificada = estado;}
        function getModificada(){return modificada;}

        function setActividad(codigo){actividad = codigo;}
        function getActividad(){return actividad;}

        function getProyeccion(){return proyeccion;}
        function setProyeccion(datos){proyeccion = datos;}

        function getProyeccionComp(){return proyeccion_comp;}
        function setProyeccionComp(datos){proyeccion_comp = datos;}

        function getPlanificacion(){return planificacion;}
        function setPlanificacion(datos){planificacion = datos;}

        function getPlanificacionComp(){return planificacion_comp;}
        function setPlanificacionComp(datos){planificacion_comp = datos;}

        function getCeldaEditada(){return celda_editada;}
        function setCeldaEditada(elemento){celda_editada = elemento;}

        return{
            setItem:setItem,
            getItem:getItem,
            getPlan:getPlan,
            setModificada:setModificada,
            getModificada:getModificada,
            setActividad:setActividad,
            getActividad:getActividad,
            getProyeccion:getProyeccion,
            setProyeccion:setProyeccion,
            getProyeccionComp:getProyeccionComp,
            setProyeccionComp:setProyeccionComp,
            getPlanificacion:getPlanificacion,
            setPlanificacion:setPlanificacion,
            getPlanificacionComp:getPlanificacionComp,
            setPlanificacionComp:setPlanificacionComp,
            getCeldaEditada:getCeldaEditada,
            setCeldaEditada:setCeldaEditada
        }
    }();

    // Evento que permite enviar una alerta al usuario cuando esta tratando de salir de la pagina y hay
    // cambios que no han sido guardados
    $(window).bind("beforeunload",function(event) {
        if(obj_trabajo.getModificada()) 
            return "Hay cambios que no han sido guardados, ¿está seguro de querer salir?";
    });

    // Primera actividad a la que se ingresa al trabajar una planificacion (proyectar ventas)
    $( "#enlace-proyeccion" ).addClass( "opcion-seleccionada" );

    /*
    Actualiza el atributo actividad del objeto obj_trabajo. Con esto se especifica el tipo de actividad
    que el usuario se encuentra realizando:
        - 1 Proyeccion
        - 2 Planificacion TV
        - 3 Planificacion AS
        - 4 Resumen
    */
    $( ".enlace-actividades" ).click(function(){
        switch ($(this).attr('id')){
            case 'enlace-proyeccion':
                obj_trabajo.setActividad(1);
                $( ".enlace-actividades" ).removeClass( "opcion-seleccionada" );
                $( "#enlace-proyeccion" ).addClass( "opcion-seleccionada" );
                $( "#tab_item_proyeccion" ).show();
                $( "#tab_item_proyeccion_comp" ).show();
                $( "#tab_item_planificacion_tv" ).hide();
                $( "#tab_item_planificacion_tv_comp" ).hide();
                break;
            case 'enlace-planificacion-tv':
                obj_trabajo.setActividad(2);
                $( ".enlace-actividades" ).removeClass( "opcion-seleccionada" );
                $( "#enlace-planificacion-tv" ).addClass( "opcion-seleccionada" );
                $( "#tab_item_proyeccion" ).hide();
                $( "#tab_item_proyeccion_comp" ).hide();
                $( "#tab_item_planificacion_tv" ).show();
                $( "#tab_item_planificacion_tv_comp" ).show();
                break;
            case 'enlace-planificacion-as':
                obj_trabajo.setActividad(3);
                $( ".enlace-actividades" ).removeClass( "opcion-seleccionada" );
                $( "#enlace-planificacion-as" ).addClass( "opcion-seleccionada" );
                break;
            case 'enlace-resumen':
                obj_trabajo.setActividad(4);
                $( ".enlace-actividades" ).removeClass( "opcion-seleccionada" );
                $( "#enlace-resumen" ).addClass( "opcion-seleccionada" );
                break;
            default:
                alert("No se ha escogido ninguna actividad!");
                obj_trabajo.setActividad(0);
                break;
        }
    });

    /* Cada vez que un usuario hace click sobre un input, el contenido 
    aparece seleccionado */
    $('input[type=text]').click(function() {
        $(this).select();
    });

    /* Cada vez que se envia un AJAX request se despliega un imagen que 
    notifica al usuario que hay un proceso en desarrollo */
    $( document ).ajaxStart(function() {
        $("#dvLoading").show();
    });

    /* Cada vez que se recibe una respuesta a una solicitud AJAX se
    esconde la imagen desplegada en la funcion anterior */
    $( document ).ajaxStop(function() {
        $("#dvLoading").hide();
    });

    /* Para que al hacer click en la tecla ENTER, los formularios de
    los dialogs sean enviados */
    $('body').on('keypress', '.ui-dialog', function(event) { 
        if (event.keyCode === $.ui.keyCode.ENTER) { 
            $('.ui-dialog-buttonpane button:first', $(this)).click();
            return false;
        }
    }); 

    /* Para la activicion de tooltips */
    $( document ).tooltip({
        track: true
    });

    /* Permite abrir varios paneles del acordeon simultaneamente */
    $('#accordion').accordion({
        collapsible: true,
        heightStyle: "content",
        beforeActivate: function(event, ui) {
             // The accordion believes a panel is being opened
            if (ui.newHeader[0]) {
                var currHeader  = ui.newHeader;
                var currContent = currHeader.next('.ui-accordion-content');
             // The accordion believes a panel is being closed
            } else {
                var currHeader  = ui.oldHeader;
                var currContent = currHeader.next('.ui-accordion-content');
            }
             // Since we've changed the default behavior, this detects the actual status
            var isPanelSelected = currHeader.attr('aria-selected') == 'true';
            
             // Toggle the panel's header
            currHeader.toggleClass('ui-corner-all',isPanelSelected).toggleClass('accordion-header-active ui-state-active ui-corner-top',!isPanelSelected).attr('aria-selected',((!isPanelSelected).toString()));
            
            // Toggle the panel's icon
            currHeader.children('.ui-icon').toggleClass('ui-icon-triangle-1-e',isPanelSelected).toggleClass('ui-icon-triangle-1-s',!isPanelSelected);
            
             // Toggle the panel's content
            currContent.toggleClass('accordion-content-active',!isPanelSelected)    
            if (isPanelSelected) { currContent.slideUp(); }  else { currContent.slideDown(); }

            return false; // Cancels the default action
        }
    });
    
    /*
    Se preocupa de cargar los elementos SELECT para la seleccion del item a trabajar.
    */
    function buscarCategoria(){
        var id_this = $(this).attr("id");
        var id_item = $(this).val();
        var id_plan = obj_trabajo.getPlan();
        if(id_item != -1){
            $.ajax({
                data: {'id_item':id_item, 'id_plan':id_plan},
                url: '/planes/plan/buscar-lista-items/',
                type: 'get',
                success: function(data){
                    // Se revisa si la consulta AJAX devolvio un resultado procesable (lista de objetos item o itemplan)
                    html = '';
                    html += "<option value=\"-1\"></option>"
                    for (var x=0; x<data.items.length; x++){
                        // Se revisa si el tipo de resultado es una lista de itemplan (combo de resultado) o items (combo de busqueda o comparacion)
                        if ( typeof data.items[x].precio === "undefined" )
                                html += '<option value="' + data.items[x].id + '">' + data.items[x].nombre + '</option>';
                        else
                            html += '<option value="' 
                            + data.items[x].id + '">' 
                            + data.items[x].estado + ' | ' 
                            //+ data.items[x].categoria_nombre + ' | ' 
                            + data.items[x].nombre + ' | ' 
                            + numeral(data.items[x].precio).format('0,0') + '</option>';
                    }
                    // Se revisa si la categoria es planificable (por lo tanto carga el resultado en el combo de items)
                    if (!data.categoria.planificable)
                        $("#combo_cat_proy_" + data.categoria.id_categoria).html(html);
                    else
                        $("#combo_resultado").html(html);       
                }
            });
        }
        else{
        }
    }

    /*
    Se preocupa de cargar los elementos SELECT para la seleccion del item a comparar.
    */
    function buscarCategoriaComparacion(){
        var id_this = $(this).attr("id");
        var id_this_arry = id_this.split("_");
        var id_item = $("#combo_cat_comp_" + id_this_arry[3]).val();
        var id_plan = obj_trabajo.getPlan();
        if(id_item != -1){
            $.ajax({
                data: {'id_item':id_item, 'id_plan':id_plan},
                url: '/planes/plan/buscar-lista-items-comparacion/',
                type: 'get',
                success: function(data){
                    if ( data.items != null ){
                        html = '';
                        html += "<option value=\"-1\"></option>"
                        for (var x=0; x<data.items.length; x++){
                            if ( data.items[x].precio != 0 )
                                html += '<option value="' + data.items[x].id + '">' + data.items[x].nombre + ' | ' + numeral(data.items[x].precio).format('0,0') + '</option>';
                            else
                                html += '<option value="' + data.items[x].id + '">' + data.items[x].nombre + '</option>';
                        }
                        $("#combo_cat_comp_" + data.categoria.id_categoria).html(html);
                    }
                    else{
                    }
                }
            });
        }
    }

    /*
        Controla los cambios hechos sobre el combobox de itemplan.
        Gatilla una busqueda sobre la informacion comercial del itemplan
        seleccionado.
    */
    function busquedaAJAXdatos(){
        /* Se determina el tipo de tarea que esta realizando el usuario para
        buscar la informacion necesaria (proyeccion, planificacion o resumen) */
        obj_trabajo.setItem($(this).val());
        if (obj_trabajo.getItem() != -1){
            switch(obj_trabajo.getActividad()){
                case 1:
                    console.log("BUSQUEDA PROYECCION");
                    data = {'id_itemplan':obj_trabajo.getItem(), 'id_plan':obj_trabajo.getPlan()};
                    url = '/planes/plan/buscar-datos-proyeccion/';
                    busqueda = busquedaProyeccion;
                    break;
                case 2:
                    console.log("BUSQUEDA PLANIFICACION TV");
                    data = {'id_itemplan':obj_trabajo.getItem(), 'id_plan':obj_trabajo.getPlan()};
                    url = '/planes/plan/buscar-datos-planificacion-tv/';
                    busqueda = busquedaPlanificacionTV;
                    break;
                case 3:
                    console.log("BUSQUEDA PLANIFICACION AS");
                    break;
                case 4:
                    console.log("BUSQUEDA RESUMEN");
                    break;
            }
            
            var request = $.ajax({
                data: data,
                url: url,
                type: 'get'
            });

            request.done(busqueda);
        }        
    }

    /*
        Controla los cambios hechos sobre el combobox de itemplan de comparacion.
        Gatilla una busqueda sobre la informacion comercial del itemplan
        seleccionado.
    */
    function busquedaAJAXdatosComp(id_item){
        /* Se determina el tipo de tarea que esta realizando el usuario para
        buscar la informacion necesaria (proyeccion, planificacion o resumen) */
        switch(obj_trabajo.getActividad()){
            case 1:
                console.log("BUSQUEDA PROYECCION COMP");
                data = {'id_item':id_item, 'id_plan':obj_trabajo.getPlan()};
                url = '/planes/plan/buscar-datos-proyeccion-comp/';
                busqueda = busquedaProyeccionComp;
                break;
            case 2:
                console.log("BUSQUEDA PLANIFICACION TV COMP");
                break;
            case 3:
                console.log("BUSQUEDA PLANIFICACION AS COMP");
                break;
            case 4:
                console.log("BUSQUEDA RESUMEN COMP");
                break;
        }

        var request = $.ajax({
            data: data,
            url: url,
            type: 'get'
        });

        request.done(busqueda);
    }

    $( "#dialog-box" ).dialog({
        autoOpen: false,
        width: 220,
        modal: true,
        buttons: {
            "Guardar": function() {
                /*
                parametros[0]: tipo de metrica (unidades, descuentos)
                parametros[1]: periodo
                parametros[2]: temporada
                */
                var parametros = [];
                var valor;
                var intRegex = /^\d+$/;
                var floatRegex = /^\-?([0-9]+(\.[0-9]+)?|Infinity)$/;
                var texto = "";
                parametros = obj_trabajo.getCeldaEditada().attr( "id" ).split("_");
                valor = $( "#inputval" ).val().replace('%','').replace(',','.');

                // Se revisa si el cambio corresponde a unidades o a un % de descuento
                if ( parametros[0] == "unidades" ) {
                    // Se valida que el valor ingresado sea un numero entero
                    if(intRegex.test(valor)) {
                       obj_trabajo.getCeldaEditada().text(valor);
                       actualizarProyeccion(parametros[0], parametros[1], parametros[2]);
                       $( "#inputval" ).val("");
                       if ( $( "#inputval" ).hasClass( "ui-state-error" ) )
                            $( "#inputval" ).removeClass( "ui-state-error" );
                        // Se marque que la proyeccion ha sido modificada y por lo tanto se desplegara
                        // una aleta si el usuario intenta salir de la pagina sin guardar los cambios
                        obj_trabajo.setModificada(true);
                       $( this ).dialog( "close" );
                    }
                    else {
                        $( "#inputval" ).addClass( "ui-state-error" );
                        texto = $( "#dialog_help_msg" ).text();
                        $( "#dialog_help_msg" ).html( "Sólo debe ingresar un número entero positivo." );
                        $( "#dialog_help_msg" ).addClass( "ui-state-highlight" );
                        setTimeout(function() {
                            $( "#dialog_help_msg" ).removeClass( "ui-state-highlight", 3000 );
                            $( "#dialog_help_msg" ).html(texto);
                        }, 3000 );
                    }
                }

                // Se trata de un ajuste de % de descuento
                else {
                    if(floatRegex.test(valor)) {
                        obj_trabajo.getCeldaEditada().text(valor + "%");
                        actualizarProyeccion(parametros[0], parametros[1], parametros[2]);
                        $( "#inputval" ).val("");
                        if ( $( "#inputval" ).hasClass( "ui-state-error" ) )
                        $( "#inputval" ).removeClass( "ui-state-error" );
                        // Se marque que la proyeccion ha sido modificada y por lo tanto se desplegara
                        // una aleta si el usuario intenta salir de la pagina sin guardar los cambios
                        obj_trabajo.setModificada(true);
                        $( this ).dialog( "close" );
                    }
                    else {
                        $( "#inputval" ).addClass( "ui-state-error" );
                        texto = $( "#dialog_help_msg" ).text();
                        $( "#dialog_help_msg" ).html( "Debe ingresar un número respetando el formato señalado." );
                        $( "#dialog_help_msg" ).addClass( "ui-state-highlight" );
                        setTimeout(function() {
                            $( "#dialog_help_msg" ).removeClass( "ui-state-highlight", 3000 );
                            $( "#dialog_help_msg" ).html(texto);
                        }, 3000 );
                    }
                }
            },
            Cancelar: function() {
                $( this ).dialog( "close" );
            }
        }
    });

    /*
        Ajax done callback para el evento que guarda una proyeccion
    */
    var saveAJAXDone = function(data){
        obj_trabajo.setModificada(false);
        $("#caja-mensajes")
            .show()
            .html(data.msg)
            .addClass("msg_success")
            .delay(4000)
            .queue( function(next){ 
                $(this).hide();
                $(this).removeClass("msg_success");
                $(this).html("");
                    next(); 
            });

        // Se recarga el cuadro de proyeccion con la opcion escogida
        $("#combo_resultado").trigger("change");
        crearTablaProyeccion(obj_trabajo.getProyeccion());

        // Si en algun momento se escogio un item comparativo, entonces se recarga la tabla para que contenga
        // los datos que se guardaron de la ultima planificacion
        var id_item_comparativo = -1;

        $("[id^=combo_cat_comp_]").each(function(index){
            if ( $(this).val() != -1 ){
                id_item_comparativo = $(this).val();
            }
        });
        if ( id_item_comparativo != -1 )
            busquedaAJAXdatosComp(id_item_comparativo);
    };

    /*
        Guarda la proyeccion sobre la cual se esta trabajando.
    */
    /*$("#btnSave").click(function(event){
        event.preventDefault();
        var plan = obj_trabajo.getPlan();
        var itemplan = obj_trabajo.getItem();
        var ventas = obj_trabajo.getProyeccion();
        
        json_data = JSON.stringify({
            'plan': plan, 
            'itemplan': itemplan,
            'ventas': ventas.ventas
        });
        
        $("#json_data_proyeccion").val(json_data);

        $.ajax({
            data: $("#form_proyeccion").serialize(), // Se envia el form serializado para que contenga el token CSRF
            url: '/planes/plan/guardar-proyeccion/',
            type: 'post',
            
        }).done(saveAJAXDone);
        
    });*/

    $("#combo_resultado").change(busquedaAJAXdatos);
    $("[id^=button_cat_comp_]").click(function(){
        var id_item;
        var id_this = $(this).attr("id");
        // Se divide el ID del elemento BUTTON para generar el ID del elemento SELECT asociado
        // El cuarto valor del array es el ID asociado que se busca ya que el ID del elemento sigue la forma button_cat_comp_X
        id_button_array = id_this.split("_");
        id_item = $("#combo_cat_comp_" + id_button_array[3]).val();
        if ( id_item == -1 ){
            alert("Seleccione una opción válida.");
            return 0;
        }
        busquedaAJAXdatosComp(id_item);
    });
    $("[id^=combo_cat_proy_]").change(buscarCategoria);
    $("[id^=combo_cat_comp_]").change(buscarCategoriaComparacion);

});

</script>

{% endblock %}
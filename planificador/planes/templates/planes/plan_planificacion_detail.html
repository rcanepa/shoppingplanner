{% extends "base.html" %}

{% block topbar %}

{% include "planes/menu.html" %}

{% endblock %}

{% block username %}
	Bienvenido {{ full_name }} !
{% endblock %}

{% block sidebar %}
<div class="pure-menu pure-menu-open">
    <a class="pure-menu-heading">Acciones</a>
    <ul>
        <li><a href="{% url 'planes:plan_detail' plan.id %}">Volver</a></li>
        <li><a id="btnProyeccion">Ajustar Proyecci&oacute;n</a></li>
        <li><a id="btnResumen">Ver Resumen</a></li>
        <li class="pure-menu-disabled" id="panel-acciones"><a href="" id="btnSave">Guardar Planificaci&oacute;n</a></li>
    </ul>
</div>

<!-- Seccion con parametros de busqueda del item a proyectar  -->
<div class="caja_bordes" style="padding: 0px 0px; float:left; width:100%;">
    <a class="caja-header">Planificaci&oacute;n</a>
    <table style="width:100%;">
        {% for categoria in combo_categorias %}
        <tr>
            <td><label>{{ categoria.nombre }}</label></td>
        </tr>
        <tr>
            <td>
                <select id="combo_cat_plan_{{ categoria.id }}" class="buscador">
                    <option value="-1" selected></option>
                    {% for item in items_categoria_raiz %}
                        {% if item.categoria = categoria %}
                        <option value="{{ item.id }}">{{ item.nombre }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </td>
        </tr>
        {% endfor %}
        <tr>
            <td><label>ITEMS</label></td>
        </tr>
        <tr>
            <td>
                <select id="combo_resultado" class="buscador">
                </select>
            </td>
        </td>
    </table>
    <a class="caja-header">Comparativo</a>
    <table style="width:100%;">
        {% for categoria in combo_categorias_comp %}
        <tr>
            <td style="width:80%">
                <label>{{ categoria.nombre }}</label>
            </td>
            <td style="width:20%"></td>
        </tr>
        <tr>
            <td style="width:80%">
                <select id="combo_cat_comp_{{ categoria.id }}" class="buscador">
                    <option value="-1" selected></option>
                    {% for item in items_categoria_raiz %}
                        {% if item.categoria = categoria %}
                        <option value="{{ item.id }}">{{ item.nombre }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </td>
            <td style="width:20%">
                <button type="button" id="button_cat_comp_{{ categoria.id }}" class="pure-button pure-button-active" style="font-size: 70%;background: rgb(66, 184, 221);">></button>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>

<!-- Seccion con parametros de busqueda del item a proyectar  -->
{% endblock %}

{% block content %}
{% if msg %}
<h3>Proyectar Informaci贸n</h3>
<div class="msg_warning">
    {{ msg }}
</div>
{% else %}

<div id="accordion">
    <h3>Planificaci&oacute;n</h3>
    <div>
        <div id="estadisticas-proyeccion" style="display:none;"></div>
        <div style="float:left; width:100%; display:none;">
            <div style="float:left; width:7%;">Item:</div><div id="item-planificacion" style="float:left; width:50%;"></div>
        </div>
        <div style="float:left; width:100%;">
            <div style="float:left; width:7%;">Precio Blanco:</div>
            <div id="itemprecio_blanco" class="editable" style="float:left; width:7%;"></div>
            <div style="float:left; width:7%; padding-left: 10px;">Costo Unitario:</div>
            <div id="itemcosto_unitario" class="editable" style="float:left; width:20%;"></div>
        </div>
        <div style="width:100%; float:left">
            <form id="proyform" class="pure-form">
                {% csrf_token %}
                <div style="width:100%; float:left;">
                    <div id="tab_proyeccion_etiquetas" style="width:10%; float:left;">
                    </div>
                    <div id="tab_proyeccion_datos" style="width:90%; float:left;">
                    </div>
                </div>
                <div style="width:100%; float:left; padding-top:10px; padding-bottom:10px;">
                    <input id="input_json_data" type="hidden" name="proyeccion" value="" />
                </div>
            </form>
        </div>
    </div>
    <h3>Comparativo</h3>
    <div>
        <div id="item-comparativo"></div>
        
        <div style="width:100%; float:left;">
            <div id="tab_comparativo_etiquetas" style="width:10%; float:left;">
            </div>
            <div id="tab_comparativo_datos" style="width:90%; float:left;">
            </div>
        </div>
    </div>
</div>

<!-- Dialog para el ingreso de unidades y descuentos de la planificacion -->
<div id="dialog-box" title="Planificaci贸n" style="text-align:center;">
    <p id="dialog_help_msg"></p>
    <input id="inputval" type="text" style="width:8em">
</div>

<!-- Dialog para el ingreso de unidades y descuentos de la proyeccion -->
<div id="dialog-box-proyeccion" title="Proyecci贸n" style="text-align:center;">
    <p id="dialog_proy_help_msg"></p>
    <input id="inputvalproy" type="text" style="width:8em">
</div>

<!-- Dialog con la vista de proyeccion -->
<div id="dialog-proyeccion" title="Proyecci贸n">
    <div id="contenedor-dialog-proyeccion">
    </div>
    <form id="form-proyeccion" class="pure-form">
        {% csrf_token %}
        <div style="width:100%; float:left; padding-top:10px; padding-bottom:10px;">
            <input id="json-data-proyeccion" type="hidden" name="proyeccion" value="" />
        </div>
    </form>
</div>

<!-- Dialog con la vista de resumen -->
<div id="dialog-resumen" title="Resumen">
    <div id="dashboard" class="pure-g" style="display:none;">
        <div class="pure-u-1-2" style="height:270px;">
            <div>Venta</div>
            <div style="height:90%;"><canvas id="venta-chart" width="500" height="250">[No canvas support]</canvas></div>
        </div>

        <div class="pure-u-1-2" style="height:270px;">
            <div>Contribuci&oacute;n y Margen</div>
            <div style="height:90%;"><canvas id="contribucion-chart" width="500" height="250">[No canvas support]</canvas></div>
        </div>

        <div class="pure-u-1-2" style="height:270px;">
            <div>Unidades</div>
            <div style="height:90%;"><canvas id="unidades-chart" width="500" height="250">[No canvas support]</canvas></div>
        </div>

        <div class="pure-u-1-2" style="height:270px;">
            <div>Precio Blanco</div>
            <div style="height:90%;"><canvas id="precio-chart" width="500" height="250">[No canvas support]</canvas></div>
        </div>
    </div>
</div>

<div id="dvLoading" style="display:none;"></div>

{% endif%}

{% endblock %}

{% block js %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static "css/planes/planificacion.css" %}">
<script src="{% static "js/rgraph/RGraph.common.core.js" %}"></script>
<script src="{% static "js/rgraph/RGraph.common.dynamic.js" %}"></script>   <!-- Just needed for dynamic features (eg tooltips) -->

<script src="{% static "js/rgraph/RGraph.common.annotate.js" %}"></script>  <!-- Just needed for annotating -->
<script src="{% static "js/rgraph/RGraph.common.context.js" %}"></script>   <!-- Just needed for context menus -->
<script src="{% static "js/rgraph/RGraph.common.tooltips.js" %}"></script>  <!-- Just needed for tooltips -->
<script src="{% static "js/rgraph/RGraph.drawing.rect.js" %}"></script>

<script src="{% static "js/rgraph/RGraph.bar.js" %}"></script>              <!-- Just needed for Bar charts -->
<script src="{% static "js/rgraph/RGraph.line.js" %}"></script>             <!-- Just needed for Line charts -->
<script>

$(function() {

    $( "#plan_planificacion_detail" ).addClass( "opcion-seleccionada" );

    obj_planificacion = function(){
        var id_item = null;
        var id_itemplan = null;
        var id_item_comp = null;
        var id_plan = parseInt({{plan.id}});
        var data_proyeccion = null;
        
        function setItem(id){
            id_item = id;
        }
        
        function getItem(){
            return id_item;
        }

        function setItemplan(id){
            id_itemplan = id;
        }
        
        function getItemplan(){
            return id_itemplan;
        }
        
        function setItemComp(id){
            id_item_comp = id;
        }
        
        function getItemComp(){
            return id_item_comp;
        }

        function getPlan(){
            return id_plan;
        }

        function setDataProyeccion(data){
            data_proyeccion = data;
        }

        function getDataProyeccion(){
            return data_proyeccion;
        }
        
        return{
            setItem:setItem,
            getItem:getItem,
            setItemplan:setItemplan,
            getItemplan:getItemplan,
            setItemComp:setItemComp,
            getItemComp:getItemComp,
            getPlan:getPlan,
            setDataProyeccion:setDataProyeccion,
            getDataProyeccion:getDataProyeccion
        }

    }();

    var planificacion = [];
    var comparacion = [];

    var td = "";

    $( document ).tooltip({
        track: true
    });

    $( document ).ajaxStart(function() {
        $("#dvLoading").show();
    });

    $( document ).ajaxStop(function() {
        $("#dvLoading").hide();
    });

    /*
        Dialog para el ingreso de valores de unidades, descuentos, precio blanco, costo o costo unitario
    */
    $( "#dialog-box" ).dialog({
        autoOpen: false,
        height: 200,
        width: 250,
        modal: true,
        buttons: {
            "Guardar": function() {
                /*
                    parametros[0]: tipo de metrica (unidades, descuentos, costos, costo unitario, precio blanco)
                    parametros[1]: periodo
                    parametros[2]: temporada
                */
                var parametros = [];
                var valor;
                var intRegex = /^\d+$/;
                var floatRegex = /^\-?([0-9]+(\.[0-9]+)?|Infinity)$/;
                var texto = "";
                parametros = td.attr("id").split("_");
                valor = $( "#inputval" ).val().replace('%','').replace(',','.');
            
                // Se valida si el pararametro que esta siendo modificado pertenece al grupo precio blanco / costo unitario
                // o al grupo descuento / unidades / costos
                if ( parametros[0].indexOf("item") == -1){
                    // Se revisa si el cambio corresponde a unidades o a un % de descuento
                    if ( parametros[0] == "unidades" ) {
                        // Se valida que el valor ingresado sea un numero entero
                        if(intRegex.test(valor)) {
                           td.text(valor);
                           actualizarPerPlanificacion(parametros[0], parametros[1], parametros[2]);
                           $( "#inputval" ).val("");
                           if ( $( "#inputval" ).hasClass( "ui-state-error" ) )
                                $( "#inputval" ).removeClass( "ui-state-error" );
                           $( this ).dialog( "close" );
                        }
                        else {
                            $( "#inputval" ).addClass( "ui-state-error" );
                            texto = $( "#dialog_help_msg" ).text();
                            $( "#dialog_help_msg" ).html( "S贸lo debe ingresar un n煤mero entero positivo." );
                            $( "#dialog_help_msg" ).addClass( "ui-state-highlight" );
                            setTimeout(function() {
                                $( "#dialog_help_msg" ).removeClass( "ui-state-highlight", 3000 );
                                $( "#dialog_help_msg" ).html(texto);
                            }, 3000 );
                        }
                    }

                    // Se trata de un ajuste de % de descuento
                    else {
                        if(floatRegex.test(valor)) {
                            td.text(valor + "%");
                            actualizarPerPlanificacion(parametros[0], parametros[1], parametros[2]);
                            $( "#inputval" ).val("");
                            if ( $( "#inputval" ).hasClass( "ui-state-error" ) )
                                $( "#inputval" ).removeClass( "ui-state-error" );
                            $( this ).dialog( "close" );
                        }
                        else {
                            $( "#inputval" ).addClass( "ui-state-error" );
                            texto = $( "#dialog_help_msg" ).text();
                            $( "#dialog_help_msg" ).html( "Debe ingresar un n煤mero respetando el formato se帽alado." );
                            $( "#dialog_help_msg" ).addClass( "ui-state-highlight" );
                            setTimeout(function() {
                                $( "#dialog_help_msg" ).removeClass( "ui-state-highlight", 3000 );
                                $( "#dialog_help_msg" ).html(texto);
                            }, 3000 );
                        }
                    }
                    
                }
                // Se trata del precio blanco o costo unitario
                else{
                    // Se valida que el precio blanco o costo unitario sea un numero entero
                    valor = valor.replace(',','').replace('.','');
                    if ( intRegex.test(valor) ){
                        if ( parametros[0] == "itemprecio" ){
                            planificacion.itemplan.precio = numeral().unformat(valor);    
                            $("#itemprecio_blanco").text(numeral(valor).format('0,0'));
                        }
                        else{
                            planificacion.itemplan.costo_unitario = numeral().unformat(valor);
                            $("#itemcosto_unitario").text(numeral(valor).format('0,0'));  
                        }
                            
                        $( "#inputval" ).val("");
                        if ( $( "#inputval" ).hasClass( "ui-state-error" ) )
                            $( "#inputval" ).removeClass( "ui-state-error" );
                        actualizarPlanificacion();  
                        $( this ).dialog( "close" );
                    }
                    else{
                        $( "#inputval" ).addClass( "ui-state-error" );
                        texto = $( "#dialog_help_msg" ).text();
                        $( "#dialog_help_msg" ).html( "Debe ingresar un n煤mero entero." );
                        $( "#dialog_help_msg" ).addClass( "ui-state-highlight" );
                        setTimeout(function() {
                            $( "#dialog_help_msg" ).removeClass( "ui-state-highlight", 3000 );
                            $( "#dialog_help_msg" ).html(texto);
                        }, 3000 );
                    }
                }
            },
            Cancelar: function() {
                $( this ).dialog( "close" );
            }
        }
    });

    /*
        Configuracion del dialog con la vista de proyeccion
    */
    $( "#dialog-proyeccion" ).dialog({
        autoOpen: false,
        height: $( window ).height(),
        width: $( window ).width() - 100,
        modal: true,
        buttons: {
            "Guardar": function() {

                var plan = obj_planificacion.getPlan();
                var itemplan = obj_planificacion.getItemplan();
                var proyeccion = obj_planificacion.getDataProyeccion();
                
                json_data = JSON.stringify({
                    'plan': plan, 
                    'itemplan': itemplan,
                    'ventas': proyeccion.ventas
                });
                
                $("#json-data-proyeccion").val(json_data);

                // Se almacenan los cambios realizados a la proyeccion
                var request = $.ajax({
                    data: $("#form-proyeccion").serialize(), // Se envia el form serializado para que contenga el token CSRF
                    url: '/planes/plan/savestage2/',
                    type: 'post',
                    
                });
                
                // Se gatilla la generacion del mensaje de respuesta/notificacion
                request.done(respuestaMsgAjax);
                
                // Se gatilla una funcion que actualiza el contenido de la tabla de planificacion y comparativo
                request.done(function(){
                    
                    // Se recarga el cuadro de planificacion con la opcion escogida
                    $("#combo_resultado").trigger("change");
                    buscarEstadisticasPlan();
                    tablaDctoUni(planificacion);
                    
                    // Si en algun momento se escogio un item comparativo, entonces se recarga la tabla para que contenga
                    // los datos que se guardaron de la ultima planificacion
                    var id_item_comparativo = -1;

                    $("[id^=combo_cat_comp_]").each(function(index){
                        if ( $(this).val() != -1 ){
                            id_item_comparativo = $(this).val();
                        }
                    });
                    if ( id_item_comparativo != -1 )
                        buscarTablaComparacionAJAX_par(id_item_comparativo);
                });

                // Se limpia el objeto de proyeccion
                obj_planificacion.setDataProyeccion(null);
                $( this ).dialog( "close" );
            },
            Cancelar: function() {
                $( this ).dialog( "close" );
            }
        }
    });

    /*
        Configuracion del dialog para el ajuste del monto en unidades o % de descuento de una proyeccion
    */
    $( "#dialog-box-proyeccion" ).dialog({
        autoOpen: false,
        height: 200,
        width: 250,
        modal: true,
        buttons: {
            "Guardar": function() {
                /*
                parametros[0]: tipo de metrica (unidades, descuentos)
                parametros[1]: periodo
                parametros[2]: temporada
                */
                var parametros = [];
                var valor;
                var intRegex = /^\d+$/;
                var floatRegex = /^\-?([0-9]+(\.[0-9]+)?|Infinity)$/;
                var texto = "";
                parametros = td.attr( "id" ).split("_");
                valor = $( "#inputvalproy" ).val().replace('%','').replace(',','.');

                // Se revisa si el cambio corresponde a unidades o a un % de descuento
                if ( parametros[0] == "unidades" ) {
                    // Se valida que el valor ingresado sea un numero entero
                    if(intRegex.test(valor)) {
                       td.text(valor);
                       actualizarProyeccion(parametros[0], parametros[1], parametros[2]);
                       $( "#inputvalproy" ).val("");
                       if ( $( "#inputvalproy" ).hasClass( "ui-state-error" ) )
                            $( "#inputvalproy" ).removeClass( "ui-state-error" );
                       $( this ).dialog( "close" );
                    }
                    else {
                        $( "#inputvalproy" ).addClass( "ui-state-error" );
                        texto = $( "#dialog_proy_help_msg" ).text();
                        $( "#dialog_proy_help_msg" ).html( "S贸lo debe ingresar un n煤mero entero positivo." );
                        $( "#dialog_proy_help_msg" ).addClass( "ui-state-highlight" );
                        setTimeout(function() {
                            $( "#dialog_proy_help_msg" ).removeClass( "ui-state-highlight", 3000 );
                            $( "#dialog_proy_help_msg" ).html(texto);
                        }, 3000 );
                    }
                }

                // Se trata de un ajuste de % de descuento
                else {
                    if(floatRegex.test(valor)) {
                        td.text(valor + "%");
                        actualizarProyeccion(parametros[0], parametros[1], parametros[2]);
                        $( "#inputvalproy" ).val("");
                        if ( $( "#inputvalproy" ).hasClass( "ui-state-error" ) )
                        $( "#inputvalproy" ).removeClass( "ui-state-error" );
                        $( this ).dialog( "close" );
                    }
                    else {
                        $( "#inputvalproy" ).addClass( "ui-state-error" );
                        texto = $( "#dialog_proy_help_msg" ).text();
                        $( "#dialog_proy_help_msg" ).html( "Debe ingresar un n煤mero respetando el formato se帽alado." );
                        $( "#dialog_proy_help_msg" ).addClass( "ui-state-highlight" );
                        setTimeout(function() {
                            $( "#dialog_proy_help_msg" ).removeClass( "ui-state-highlight", 3000 );
                            $( "#dialog_proy_help_msg" ).html(texto);
                        }, 3000 );
                    }
                }
            },
            Cancelar: function() {
                $( this ).dialog( "close" );
            }
        }
    });

    /*
        Configuracion dialog con la vista de resumen
    */
    $( "#dialog-resumen" ).dialog({
        autoOpen: false,
        height: $( window ).height(),
        width: $( window ).width() - 100,
        modal: true,
        buttons: {
            "Cerrar": function() {
                $( this ).dialog( "close" );
            }
        }
    });

    // Mantener sincronizado el movimiento del scroll inferior con el superior
    $("#tab_proyeccion_datos").on("scroll", function () {
        $("#tab_comparativo_datos").scrollLeft($(this).scrollLeft());
    });

    // Mantener sincronizado el movimiento del scroll superior con el inferior
    $("#tab_comparativo_datos").on("scroll", function () {
        $("#tab_proyeccion_datos").scrollLeft($(this).scrollLeft());
    });

    // Se asocia el evento keypress al primer boton de cualquier dialog, para que cada vez que se
    // presione la tecla ENTER, el dialog sea enviado
    $('body').on('keypress', '.ui-dialog', function(event) { 
        if (event.keyCode === $.ui.keyCode.ENTER) { 
            $('.ui-dialog-buttonpane button:first', $(this)).click();
            return false;
        }
    });

    /* Actualiza las estadisticas generales de proyeccion */
    function buscarEstadisticasPlan(){
        var id_plan = parseInt({{plan.id}});
        $.ajax({
            data: {'id_plan':id_plan}, // Se envia el form serializado para que contenga el token CSRF
            url: '/planes/plan/planstats/',
            type: 'get',
            success: function(data){
                msg = "Totales: " + data['num_items_tot'] + " | Planificados: " + data['num_items_pro'] + " | Pendientes: " + data['num_items_nopro'];
                $("#estadisticas-proyeccion").html(msg);
            }
        });
    }

    /* Permite abrir varios paneles del acordion simultaneamente */
    $('#accordion').accordion({
        collapsible: true,
        heightStyle: "content",
        beforeActivate: function(event, ui) {
             // The accordion believes a panel is being opened
            if (ui.newHeader[0]) {
                var currHeader  = ui.newHeader;
                var currContent = currHeader.next('.ui-accordion-content');
             // The accordion believes a panel is being closed
            } else {
                var currHeader  = ui.oldHeader;
                var currContent = currHeader.next('.ui-accordion-content');
            }
             // Since we've changed the default behavior, this detects the actual status
            var isPanelSelected = currHeader.attr('aria-selected') == 'true';
            
             // Toggle the panel's header
            currHeader.toggleClass('ui-corner-all',isPanelSelected).toggleClass('accordion-header-active ui-state-active ui-corner-top',!isPanelSelected).attr('aria-selected',((!isPanelSelected).toString()));
            
            // Toggle the panel's icon
            currHeader.children('.ui-icon').toggleClass('ui-icon-triangle-1-e',isPanelSelected).toggleClass('ui-icon-triangle-1-s',!isPanelSelected);
            
             // Toggle the panel's content
            currContent.toggleClass('accordion-content-active',!isPanelSelected)    
            if (isPanelSelected) { currContent.slideUp(); }  else { currContent.slideDown(); }

            return false; // Cancels the default action
        }
    });
    
    /*
        Ajax done callback para el evento que guarda una proyeccion
    */
    var saveAJAXDone = function(data){
        $("#barra_notificaciones")
            .html(data.msg)
            .addClass("msg_success")
            .delay(3000)
            .queue( function(next){ 
                $(this).removeClass("msg_success");
                $(this).html("");
                    next(); 
            });

        // Se recarga el cuadro de proyeccion con la opcion escogida
        $("#combo_resultado").trigger("change");
        buscarEstadisticasPlan();
        tablaDctoUni(planificacion);
        // Si en algun momento se escogio un item comparativo, entonces se recarga la tabla para que contenga
        // los datos que se guardaron de la ultima planificacion
        var id_item_comparativo = -1;

        $("[id^=combo_cat_comp_]").each(function(index){
            if ( $(this).val() != -1 ){
                id_item_comparativo = $(this).val();
            }
        });
        if ( id_item_comparativo != -1 )
            buscarTablaComparacionAJAX_par(id_item_comparativo);
    };

    /*
        Guarda la planificacion sobre la cual se esta trabajando.
    */

    $("#btnSave").click(function(event){
        event.preventDefault();
        var plan = parseInt({{plan.id}});
        var itemplan = planificacion['itemplan'].id_itemplan
        
        json_data = JSON.stringify({
            'plan': plan, 
            'itemplan': itemplan,
            'ventas': planificacion.ventas
        });
        
        $("#input_json_data").val(json_data);
        $.ajax({
            data: $("#proyform").serialize(), // Se envia el form serializado para que contenga el token CSRF
            url: '/planes/plan/savestage3/',
            type: 'post'
        }).done(saveAJAXDone);

        
    });

    /*
    Se preocupa de cargar los elementos SELECT para la seleccion del item a planificar (comboboxes de planificacion).
    */
    function buscarCategoriaPlanificacion(){
        var id_this = $(this).attr("id");
        var id_item = $(this).val();
        var id_plan = parseInt({{plan.id}});
        if(id_item != -1){
            $.ajax({
                data: {'id_item':id_item, 'id_plan':id_plan},
                url: '/planes/plan/categoriasearchlist/',
                type: 'get',
                success: function(data){
                    // Se revisa si la consulta AJAX devolvio un resultado procesable (lista de items o itemsplan)
                    html = '';
                    html += "<option value=\"-1\"></option>"
                    for (var x=0; x<data.items.length; x++){
                        // Se revisa si el tipo de resultado es una lista de itemplan (combo de resultado) o items (combo de busqueda o comparacion)
                        if ( typeof data.items[x].precio === "undefined" )
                                html += '<option value="' + data.items[x].id + '">' + data.items[x].nombre + '</option>';
                        else
                            html += '<option value="' 
                            + data.items[x].id + '">' 
                            + data.items[x].estado + ' | ' 
                            //+ data.items[x].categoria_nombre + ' | ' 
                            + data.items[x].nombre + ' | ' 
                            + numeral(data.items[x].precio).format('0,0') + '</option>';
                    }
                    // Se revisa si la categoria es planificable (por lo tanto carga el resultado en el combo de items)
                    if (!data.categoria.planificable)
                        $("#combo_cat_plan_" + data.categoria.id_categoria).html(html);
                    else
                        $("#combo_resultado").html(html);       
                }
            });
        }
        else{
        }
    }

    /*
    Se preocupa de cargar los elementos SELECT para la seleccion del item a comparar (comboboxes comparativo).
    */
    function buscarCategoriaComparacion(){
        var id_this = $(this).attr("id");
        var id_this_arry = id_this.split("_");
        var id_item = $("#combo_cat_comp_" + id_this_arry[3]).val();
        var id_plan = parseInt({{plan.id}});
        if(id_item != -1){
            $.ajax({
                data: {'id_item':id_item, 'id_plan':id_plan},
                url: '/planes/plan/categoriacompsearchlist/',
                type: 'get',
                success: function(data){
                    if ( data.items != null ){
                        html = '';
                        html += "<option value=\"-1\"></option>"
                        for (var x=0; x<data.items.length; x++){
                            if ( data.items[x].precio != 0 )
                                html += '<option value="' + data.items[x].id + '">' + data.items[x].nombre + ' | ' + numeral(data.items[x].precio).format('0,0') + '</option>';
                            else
                                html += '<option value="' + data.items[x].id + '">' + data.items[x].nombre + '</option>';
                        }
                        $("#combo_cat_comp_" + data.categoria.id_categoria).html(html);
                    }
                    else{
                    }
                }
            });
        }
    }

    /*
        Controla los cambios hechos sobre el combobox de itemplan.
        Gatilla una busqueda sobre la informacion comercial del itemplan
        selccionado.
    */
    function buscarTablaPlanificacionAJAX(){
        obj_planificacion.setItemplan($(this).val());
        $.ajax({
            data: {'id_itemplan':obj_planificacion.getItemplan(), 'id_plan':obj_planificacion.getPlan()},
            url: '/planes/plan/itemplanventatemp/',
            type: 'get',
            success: function(data){
                console.log(data);
                // Se revisa que la busqueda haya devuelto ventas. Si no devolvio datos de venta significa que no encontro el item
                // que se estaba buscando
                if( data.ventas != null ){
                    obj_planificacion.setItem(data.itemplan.id_item);
                    $("#item-planificacion").text(data.itemplan.nombre);
                    $("#itemprecio_blanco").text(numeral(data.itemplan.precio).format('0,0'));
                    $("#itemcosto_unitario").text(numeral(data.itemplan.costo_unitario).format('0,0'));
                    planificacion = data;
                    actualizarPlanificacion();
                    tablaDctoUni(data);
                }
                else{
                    alert("El item seleccionado no es v谩lido. Por favor verifique que haya escogido correctamente un item y que tenga los permisos necesarios para verlo");
                }
                
            }
        });
        if ( $("#panel-acciones").hasClass("pure-menu-disabled") )
            $("#panel-acciones").removeClass("pure-menu-disabled");
    }

    /*
        Busca la informacion historica para la seccion de comparacion. Esta funcion se gatilla al
        hacer click en uno de los BUTTON que se presentan al lado de cada uno de los SELECT de comparacion
    */
    function buscarTablaComparacionAJAX_par(id_item){
        var id_plan = parseInt({{plan.id}});
        $.ajax({
            data: {'id_item':id_item, 'id_plan':id_plan},
            url: '/planes/plan/itemplanventatempcomp/',
            type: 'get',
            success: function(data){
                //console.log(data);
                // Se revisa que la busqueda haya devuelto ventas. Si no devolvio datos de venta significa que no encontro el item
                // que se estaba buscando
                if( data.ventas != null ){
                    $("#item-comparativo").text("Item: " + data.itemplan.nombre + " | " + numeral(data.itemplan.precio).format('0,0'));
                    comparacion = data;
                    tablaDctoUniComp(data);
                    
                }
                else{
                    alert("El item seleccionado no es v谩lido. Por favor verifique que haya escogido correctamente un item y que tenga los permisos necesarios para verlo");
                }
                
            }
        });
    }

    /*
        Gatilla la busqueda de los datos de proyeccion en el caso de que se desee proyectar la informacion
        del item que se esta planificando
    */
    function buscarTablaProyeccionAJAX(){
        var id_item = obj_planificacion.getItemplan();
        var id_plan = obj_planificacion.getPlan();

        // Se valida que el id no sea nulo, es decir, que se haya escogido un item a planificar antes
        if ( id_item ){
            $.ajax({
                data: {'id_itemplan':id_item, 'id_plan':id_plan},
                url: '/planes/plan/itemplanventasearch/',
                type: 'get',
                success: function(data){
                    console.log(data);
                    // Se revisa que la busqueda haya devuelto ventas. Si no devolvio datos de venta significa que no encontro el item
                    // que se estaba buscando
                    if( data.ventas != null ){
                        obj_planificacion.setDataProyeccion(data);
                        tablaProyeccion(data);
                    }
                    else{
                        alert("El item seleccionado no es v谩lido. Por favor verifique que haya escogido correctamente un item y que tenga los permisos necesarios para verlo");
                    }
                }
            });
        }
        else{
            alert("Primero debe seleccionar un item.");
        }
    }

    function planificarMetricas(){
        // Se asigna a td la celda que ha sido presionada para proyectar su valor
        td = $(this);
        // Se hace un split sobre el id de la celda para obtener el tipo de celda (unidad o dcto), periodo y temporada
        parametros = td.attr("id").split("_");
        // Se agrega el valor de la celda al input box del dialog
        $("#inputval").val(td.text());
        //$("#inputval").val(numeral().unformat(td.text()));
        // Se customiza el mensaje del dialog en base al tipo de celda que se esta proyectando
        if(parametros[0] == 'unidades')
            $("#dialog_help_msg").text("Ingresar unidades:");
        else if(parametros[0] == 'descuentos')
            $("#dialog_help_msg").text("Ingresar porcentaje (0%-100%):");
        else if(parametros[0] == 'costos')
            $("#dialog_help_msg").text("Ingresar costo unitario:");
        else if(parametros[0] == 'itemprecio')
            $("#dialog_help_msg").text("Ingresar precio blanco:");
        else
            $("#dialog_help_msg").text("Ingresar costo unitario:");
        $( "#dialog-box" ).dialog( "open" );
        $( "#dialog-box input[type=text]" ).select();
    }
    
    function tablaDctoUni(data){

        var html_num_periodos = 6;
        var html_tot_vta_n = "";
        var html_tot_ctb_n = "";
        var html_tot_margen = "";
        var html_tot_unidades = "";
        var html = "";
        var html_div_etiquetas = "";

        html += "<table class=\"datagrid\">";
        html += "<thead>";
        html += "<tr>";
        html_div_etiquetas += "<table class=\"datagrid\">";
        html_div_etiquetas += "<thead>";
        html_div_etiquetas += "<tr>";
        html_div_etiquetas += "<th class=\"label\">A帽o</th>";
        // Se genera la cabecera con los a帽os
        for (var x=0; x<data.periodos.length; x++){
            if ( (x % html_num_periodos) == 0 ){
                if ( data.periodos[x].temporada ){
                    if ( (x % html_num_periodos) == 0 )
                    html += "<th colspan=\"" + html_num_periodos + "\">" + data.periodos[x].tiempo__anio + "</th>";
                }
                else{
                    if ( (data.periodos[x].tiempo__anio % 2) == 0 )
                        html += "<th colspan=\"" + html_num_periodos + "\">" + data.periodos[x].tiempo__anio + "</th>";
                    else
                        html += "<th colspan=\"" + html_num_periodos + "\">" + data.periodos[x].tiempo__anio + "</th>";
                }
            }
        }
        html += "</tr>";
        html += "<tr>";
        html_div_etiquetas += "</tr>";
        html_div_etiquetas += "<tr>";
        html_div_etiquetas += "<th class=\"label\">Periodo</th>";
        // Se genera la fila con los periodos
        for (var x=0; x<data.periodos.length; x++){
            if ( data.periodos[x].temporada ){
                html += "<th class=\"plan\">" + data.periodos[x].nombre + "</th>";
            }
            else{
                if ( (data.periodos[x].tiempo__anio % 2) == 0 )
                    html += "<th class=\"par\">" + data.periodos[x].nombre + "</th>";
                else
                    html += "<th class=\"impar\">" + data.periodos[x].nombre + "</th>";
            }
        }
        html += "</tr>";
        html += "</thead>";
        html += "<tbody>";
        html_div_etiquetas += "</tr>";
        html_div_etiquetas += "</thead>";
        html_div_etiquetas += "<tbody>";
        
        /* Se itera por cada temporada */
        $.each(data.ventas, function(temporada, ventas) {
            html += "<tr>";
            html += "<td class=\"separador\" colspan=\"24\">-</td>";
            html += "</tr>";

            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td class=\"separador\"><b>Temporada: " + temporada + "</b></td>";
            html_div_etiquetas += "</tr>";

            /* Unidades vendidas */
            html += "<tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td title=\"Unidades vendidas.\" class=\"label\">Unidades</td>";

            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (data.temporada_vigente['anio']) )
                    html += "<td id=\"unidades_" + venta.anio + "" + venta.periodo + "_" + temporada + "\" class=\"unidades editable plan\">" + numeral(venta.vta_u).format('0,0') + "</td>";
                else{
                    if ( (venta.anio % 2) == 0 )
                        html += "<td class=\"par\">" + numeral(venta.vta_u).format('0,0') + "</td>";
                    else
                        html += "<td class=\"impar\">" + numeral(venta.vta_u).format('0,0') + "</td>";
                }
                    

            });
            html += "</tr>";
            html_div_etiquetas += "</tr>";
            
            /* Descuentos */
            html += "<tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td title=\"Descuento sobre el precio blanco.\" class=\"label\">Dcto. %</td>";
            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (data.temporada_vigente['anio']) )
                    html += "<td id=\"descuentos_" + venta.anio + "" + venta.periodo + "_" + temporada + "\" class=\"descuentos editable plan\">" + numeral(venta.dcto).format('0.00%') + "</td>";
                else{
                    if ( (venta.anio % 2) == 0 )
                        html += "<td class=\"par\">" + numeral(venta.dcto).format('0.00%') + "</td>";
                    else
                        html += "<td class=\"impar\">" + numeral(venta.dcto).format('0.00%') + "</td>";
                }
                    
            });
            html += "</tr>";
            html_div_etiquetas += "</tr>";

            /* Precio Real */
            html += "<tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td title=\"Precio real de venta.\" class=\"label\">Precio Real</td>";
            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (data.temporada_vigente['anio']) )
                    html += "<td class=\"plan\">" + numeral(venta.precio_real).format('0,0') + "</td>";
                else{
                    if ( (venta.anio % 2) == 0 )
                        html += "<td class=\"par\">" + numeral(venta.precio_real).format('0,0') + "</td>";
                    else
                        html += "<td class=\"impar\">" + numeral(venta.precio_real).format('0,0') + "</td>";    
                }
            });
            html += "</tr>";
            html_div_etiquetas += "</tr>";

            /* Costo unitario */
            html += "<tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td title=\"Costo unitario.\" class=\"label\">Costo Uni.</td>";
            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (data.temporada_vigente['anio']) )
                    html += "<td id=\"costos_" + venta.anio + "" + venta.periodo + "_" + temporada + "\" class=\"costos plan\">" + numeral(venta.costo_u).format('0,0') + "</td>";
                else{
                    if ( (venta.anio % 2) == 0 )
                        html += "<td class=\"par\">" + numeral(venta.costo_u).format('0,0') + "</td>";
                    else
                        html += "<td class=\"impar\">" + numeral(venta.costo_u).format('0,0') + "</td>";
                }
                    
            });
            html += "</tr>";
            html_div_etiquetas += "</tr>";

            /* Venta neta */
            html += "<tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td title=\"Venta en pesos.\" class=\"label\">Venta</td>";
            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (data.temporada_vigente['anio']) )
                    html += "<td class=\"plan\">" + numeral(venta.vta_n).format('0,0') + "</td>";
                else{
                    if ( (venta.anio % 2) == 0 )
                        html += "<td class=\"par\">" + numeral(venta.vta_n).format('0,0') + "</td>";
                    else
                        html += "<td class=\"impar\">" + numeral(venta.vta_n).format('0,0') + "</td>";    
                }
            });
            html += "</tr>";
            html_div_etiquetas += "</tr>";
            
             /* Contribucion */
            html += "<tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td title=\"Contribucion en pesos.\" class=\"label\">Contribuci&oacute;n</td>";
            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (data.temporada_vigente['anio']) )
                    html += "<td class=\"plan\">" + numeral(venta.ctb_n).format('0,0') + "</td>";
                else{
                    if ( (venta.anio % 2) == 0 )
                        html += "<td class=\"par\">" + numeral(venta.ctb_n).format('0,0') + "</td>";
                    else
                        html += "<td class=\"impar\">" + numeral(venta.ctb_n).format('0,0') + "</td>";
                }
            });
            html += "</tr>";
            html_div_etiquetas += "</tr>";
            
            /* Margen */
            html += "<tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td title=\"Margen porcentual.\" class=\"label\">Margen %</td>";
            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (data.temporada_vigente['anio']) )
                    html += "<td class=\"plan\">" + numeral(venta.margen).format('0.00%') + "</td>";
                else{
                    if ( (venta.anio % 2) == 0 )
                        html += "<td class=\"par\">" + numeral(venta.margen).format('0.00%') + "</td>";
                    else
                        html += "<td class=\"impar\">" + numeral(venta.margen).format('0.00%') + "</td>";
                }
            });
            html += "</tr>";
            html_div_etiquetas += "</tr>";

        });
        
        /* Totales */
        html += "<tr>";
        html += "<td class=\"separador\" colspan=\"24\">-</td>";
        html += "</tr>";
        html_div_etiquetas += "<tr>";
        html_div_etiquetas += "<td class=\"separador\"><b>Totales:</b></td>";
        html_div_etiquetas += "</tr>";
        for (var x=0; x<data.periodos.length; x++){
            var total_unidades = 0;
            var total_vta_n = 0;
            var total_ctb_n = 0;
            var total_margen = 0;
            $.each(data.ventas, function(temporada, ventas) {
                $.each(ventas, function(periodo, venta) {
                    if (periodo == (data.periodos[x].tiempo__anio + " " + data.periodos[x].nombre)){
                        total_unidades += parseFloat(venta.vta_u);
                        total_vta_n += parseFloat(venta.vta_n);
                        total_ctb_n += parseFloat(venta.ctb_n);
                        return false;
                    }
                });

            });
            if (total_vta_n != 0)
                total_margen = total_ctb_n / total_vta_n;
            if ( data.periodos[x].temporada ){
                html_tot_unidades += "<td class=\"plan\">" + numeral(total_unidades).format('0,0') + "</td>";
                html_tot_vta_n += "<td class=\"plan\">" + numeral(total_vta_n).format('0,0') + "</td>";
                html_tot_ctb_n += "<td class=\"plan\">" + numeral(total_ctb_n).format('0,0') + "</td>";
                html_tot_margen += "<td class=\"plan\">" + numeral(total_margen).format('0.00%') + "</td>";
            }
            else{
                if ( (data.periodos[x].tiempo__anio % 2) == 0 ){
                    html_tot_unidades += "<td class=\"par\">" + numeral(total_unidades).format('0,0') + "</td>";
                    html_tot_vta_n += "<td class=\"par\">" + numeral(total_vta_n).format('0,0') + "</td>";
                    html_tot_ctb_n += "<td class=\"par\">" + numeral(total_ctb_n).format('0,0') + "</td>";
                    html_tot_margen += "<td class=\"par\">" + numeral(total_margen).format('0.00%') + "</td>";
                }
                else{
                    html_tot_unidades += "<td class=\"impar\">" + numeral(total_unidades).format('0,0') + "</td>";
                    html_tot_vta_n += "<td class=\"impar\">" + numeral(total_vta_n).format('0,0') + "</td>";
                    html_tot_ctb_n += "<td class=\"impar\">" + numeral(total_ctb_n).format('0,0') + "</td>";
                    html_tot_margen += "<td class=\"impar\">" + numeral(total_margen).format('0.00%') + "</td>";
                }
            }
        }
        
        html += "<tr class=\"totales\">";
        html += html_tot_unidades;
        html += "</tr>";
        html_div_etiquetas += "<tr class=\"totales\">";
        html_div_etiquetas += "<td title=\"Total unidades temporadas.\" class=\"label\">Unidades</td>";
        html_div_etiquetas += "</tr>";

        html += "<tr class=\"totales\">";
        html += html_tot_vta_n;
        html += "</tr>";
        html_div_etiquetas += "<tr class=\"totales\">";
        html_div_etiquetas += "<td title=\"Total venta temporadas.\" class=\"label\">Venta</td>";
        html_div_etiquetas += "</tr>";

        html += "<tr class=\"totales\">";
        html += html_tot_ctb_n;
        html += "</tr>";
        html_div_etiquetas += "<tr class=\"totales\">";
        html_div_etiquetas += "<td title=\"Total contribuci&oacute;n.\" class=\"label\">Contribuci&oacute;n</td>";
        html_div_etiquetas += "</tr>";

        html += "<tr class=\"totales\">";
        html += html_tot_margen;
        html += "</tr>";
        html_div_etiquetas += "<tr class=\"totales\">";
        html_div_etiquetas += "<td title=\"Total margen.\" class=\"label\">Margen</td>";
        html_div_etiquetas += "</tr>";

        html += "</tbody>";
        html += "</table>";
        html_div_etiquetas += "</tbody>";
        html_div_etiquetas += "</table>";
        $("#tab_proyeccion_datos").html(html);
        $("#tab_proyeccion_etiquetas").html(html_div_etiquetas);
        $(".editable").click(planificarMetricas);
    }

    function tablaDctoUniComp(data){

        var html_num_periodos = 6;
        var html_tot_vta_n = "";
        var html_tot_ctb_n = "";
        var html_tot_margen = "";
        var html_tot_unidades = "";
        var html = "";        
        var html_div_etiquetas = "";

        html += "<table class=\"datagrid\">";
        html += "<thead>";
        html += "<tr>";
        html_div_etiquetas += "<table class=\"datagrid\">";
        html_div_etiquetas += "<thead>";
        html_div_etiquetas += "<tr>";
        html_div_etiquetas += "<th class=\"label\">A帽o</th>";
        // Se genera la cabecera con los a帽os
        for (var x=0; x<data.periodos.length; x++){
            if ( (x % html_num_periodos) == 0 ){
                if ( data.periodos[x].temporada ){
                    if ( (x % html_num_periodos) == 0 )
                    html += "<th colspan=\"" + html_num_periodos + "\">" + data.periodos[x].tiempo__anio + "</th>";
                }
                else{
                    if ( (data.periodos[x].tiempo__anio % 2) == 0 )
                        html += "<th colspan=\"" + html_num_periodos + "\">" + data.periodos[x].tiempo__anio + "</th>";
                    else
                        html += "<th colspan=\"" + html_num_periodos + "\">" + data.periodos[x].tiempo__anio + "</th>";
                }
            }
        }
        html += "</tr>";
        html += "<tr>";
        html_div_etiquetas += "</tr>";
        html_div_etiquetas += "<tr>";
        html_div_etiquetas += "<th class=\"label\">Periodo</th>";
        // Se genera la fila con los periodos
        for (var x=0; x<data.periodos.length; x++){
            if ( data.periodos[x].temporada ){
                html += "<th class=\"plan\">" + data.periodos[x].nombre + "</th>";
            }
            else{
                if ( (data.periodos[x].tiempo__anio % 2) == 0 )
                    html += "<th class=\"par\">" + data.periodos[x].nombre + "</th>";
                else
                    html += "<th class=\"impar\">" + data.periodos[x].nombre + "</th>";
            }
        }
        html += "</tr>";
        html += "</thead>";
        html += "<tbody>";
        html_div_etiquetas += "</tr>";
        html_div_etiquetas += "</thead>";
        html_div_etiquetas += "<tbody>";
        /* Se itera por cada temporada */
        $.each(data.ventas, function(temporada, ventas) {
            html += "<tr>";
            html += "<td class=\"separador\" colspan=\"24\">-</td>";
            html += "</tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td class=\"separador\"><b>Temporada: " + temporada + "</b></td>";
            html_div_etiquetas += "</tr>";

            /* Unidades vendidas */
            html += "<tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td title=\"Unidades vendidas.\" class=\"label\">Unidades</td>";
            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (data.temporada_vigente['anio']) )
                    html += "<td id=\"unidades_" + venta.anio + "" + venta.periodo + "_" + temporada + "\" class=\"unidades plan\">" + numeral(venta.vta_u).format('0,0') + "</td>";
                else{
                    if ( (venta.anio % 2) == 0 )
                        html += "<td class=\"par\">" + numeral(venta.vta_u).format('0,0') + "</td>";
                    else
                        html += "<td class=\"impar\">" + numeral(venta.vta_u).format('0,0') + "</td>";
                }
                    

            });
            html += "</tr>";
            html_div_etiquetas += "</tr>";
            
            /* Descuentos */
            html += "<tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td title=\"Descuento sobre el precio blanco.\" class=\"label\">Descuento %</td>";
            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (data.temporada_vigente['anio']) )
                    html += "<td id=\"descuentos_" + venta.anio + "" + venta.periodo + "_" + temporada + "\" class=\"descuentos plan\">" + numeral(venta.dcto).format('0.00%') + "</td>";
                else{
                    if ( (venta.anio % 2) == 0 )
                        html += "<td class=\"par\">" + numeral(venta.dcto).format('0.00%') + "</td>";
                    else
                        html += "<td class=\"impar\">" + numeral(venta.dcto).format('0.00%') + "</td>";
                }
                    
            });
            html += "</tr>";
            html_div_etiquetas += "</tr>";

            /* Precio Real */
            html += "<tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td title=\"Precio real de venta.\" class=\"label\">Precio Real</td>";
            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (data.temporada_vigente['anio']) )
                    html += "<td class=\"plan\">" + numeral(venta.precio_real).format('0,0') + "</td>";
                else{
                    if ( (venta.anio % 2) == 0 )
                        html += "<td class=\"par\">" + numeral(venta.precio_real).format('0,0') + "</td>";
                    else
                        html += "<td class=\"impar\">" + numeral(venta.precio_real).format('0,0') + "</td>";    
                }
            });
            html += "</tr>";
            html_div_etiquetas += "</tr>";

            /* Costo unitario */
            html += "<tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td title=\"Costo unitario.\" class=\"label\">Costo Unitario</td>";
            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (data.temporada_vigente['anio']) )
                    html += "<td id=\"costos_" + venta.anio + "" + venta.periodo + "_" + temporada + "\" class=\"costos plan\">" + numeral(venta.costo_u).format('0,0') + "</td>";
                else{
                    if ( (venta.anio % 2) == 0 )
                        html += "<td class=\"par\">" + numeral(venta.costo_u).format('0,0') + "</td>";
                    else
                        html += "<td class=\"impar\">" + numeral(venta.costo_u).format('0,0') + "</td>";
                }
                    
            });
            html += "</tr>";
            html_div_etiquetas += "</tr>";

            /* Venta neta */
            html += "<tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td title=\"Venta en pesos.\" class=\"label\">Venta</td>";
            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (data.temporada_vigente['anio']) )
                    html += "<td class=\"plan\">" + numeral(venta.vta_n).format('0,0') + "</td>";
                else{
                    if ( (venta.anio % 2) == 0 )
                        html += "<td class=\"par\">" + numeral(venta.vta_n).format('0,0') + "</td>";
                    else
                        html += "<td class=\"impar\">" + numeral(venta.vta_n).format('0,0') + "</td>";    
                }
            });
            html += "</tr>";
            html_div_etiquetas += "</tr>";
            
             /* Contribucion */
            html += "<tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td title=\"Contribucion en pesos.\" class=\"label\">Contribuci&oacute;n</td>";
            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (data.temporada_vigente['anio']) )
                    html += "<td class=\"plan\">" + numeral(venta.ctb_n).format('0,0') + "</td>";
                else{
                    if ( (venta.anio % 2) == 0 )
                        html += "<td class=\"par\">" + numeral(venta.ctb_n).format('0,0') + "</td>";
                    else
                        html += "<td class=\"impar\">" + numeral(venta.ctb_n).format('0,0') + "</td>";
                }
            });
            html += "</tr>";
            html_div_etiquetas += "</tr>";

            /* Margen */
            html += "<tr>";
            html_div_etiquetas += "<tr>";
            html_div_etiquetas += "<td title=\"Margen porcentual.\" class=\"label\">Margen %</td>";
            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (data.temporada_vigente['anio']) )
                    html += "<td class=\"plan\">" + numeral(venta.margen).format('0.00%') + "</td>";
                else{
                    if ( (venta.anio % 2) == 0 )
                        html += "<td class=\"par\">" + numeral(venta.margen).format('0.00%') + "</td>";
                    else
                        html += "<td class=\"impar\">" + numeral(venta.margen).format('0.00%') + "</td>";
                }
            });
            html += "</tr>";
            html_div_etiquetas += "</tr>";

        });
        
        /* Totales */
        html += "<tr>";
        html += "<td class=\"separador\" colspan=\"24\">-</td>";
        html += "</tr>";
        html_div_etiquetas += "<tr>";
        html_div_etiquetas += "<td class=\"separador\"><b>Totales:</b></td>";
        html_div_etiquetas += "</tr>";
        for (var x=0; x<data.periodos.length; x++){
            var total_unidades = 0;
            var total_vta_n = 0;
            var total_ctb_n = 0;
            var total_margen = 0;
            $.each(data.ventas, function(temporada, ventas) {
                $.each(ventas, function(periodo, venta) {
                    if (periodo == (data.periodos[x].tiempo__anio + " " + data.periodos[x].nombre)){
                        total_unidades += parseFloat(venta.vta_u);
                        total_vta_n += parseFloat(venta.vta_n);
                        total_ctb_n += parseFloat(venta.ctb_n);
                        return false;
                    }
                });

            });
            if (total_vta_n != 0)
                total_margen = total_ctb_n / total_vta_n;
            if ( data.periodos[x].temporada ){
                html_tot_unidades += "<td class=\"plan\">" + numeral(total_unidades).format('0,0') + "</td>";
                html_tot_vta_n += "<td class=\"plan\">" + numeral(total_vta_n).format('0,0') + "</td>";
                html_tot_ctb_n += "<td class=\"plan\">" + numeral(total_ctb_n).format('0,0') + "</td>";
                html_tot_margen += "<td class=\"plan\">" + numeral(total_margen).format('0.00%') + "</td>";
            }
            else{
                if ( (data.periodos[x].tiempo__anio % 2) == 0 ){
                    html_tot_unidades += "<td class=\"par\">" + numeral(total_unidades).format('0,0') + "</td>";
                    html_tot_vta_n += "<td class=\"par\">" + numeral(total_vta_n).format('0,0') + "</td>";
                    html_tot_ctb_n += "<td class=\"par\">" + numeral(total_ctb_n).format('0,0') + "</td>";
                    html_tot_margen += "<td class=\"par\">" + numeral(total_margen).format('0.00%') + "</td>";
                }
                else{
                    html_tot_unidades += "<td class=\"impar\">" + numeral(total_unidades).format('0,0') + "</td>";
                    html_tot_vta_n += "<td class=\"impar\">" + numeral(total_vta_n).format('0,0') + "</td>";
                    html_tot_ctb_n += "<td class=\"impar\">" + numeral(total_ctb_n).format('0,0') + "</td>";
                    html_tot_margen += "<td class=\"impar\">" + numeral(total_margen).format('0.00%') + "</td>";
                }
            }
        }
        html += "<tr class=\"totales\">";
        html += html_tot_unidades;
        html += "</tr>";
        html_div_etiquetas += "<tr class=\"totales\">";
        html_div_etiquetas += "<td title=\"Total unidades temporadas.\" class=\"label\">Unidades</td>";
        html_div_etiquetas += "</tr>";

        html += "<tr class=\"totales\">";
        html += html_tot_vta_n;
        html += "</tr>";
        html_div_etiquetas += "<tr class=\"totales\">";
        html_div_etiquetas += "<td title=\"Total venta temporadas.\" class=\"label\">Venta</td>";
        html_div_etiquetas += "</tr>";

        html += "<tr class=\"totales\">";
        html += html_tot_ctb_n;
        html += "</tr>";
        html_div_etiquetas += "<tr class=\"totales\">";
        html_div_etiquetas += "<td title=\"Total contribuci&oacute;n.\" class=\"label\">Contribuci&oacute;n</td>";
        html_div_etiquetas += "</tr>";

        html += "<tr class=\"totales\">";
        html += html_tot_margen;
        html += "</tr>";
        html_div_etiquetas += "<tr class=\"totales\">";
        html_div_etiquetas += "<td title=\"Total margen.\" class=\"label\">Margen</td>";
        html_div_etiquetas += "</tr>";

        html += "</tbody>";
        html += "</table>";
        html_div_etiquetas += "</tbody>";
        html_div_etiquetas += "</table>";
        $("#tab_comparativo_etiquetas").html(html_div_etiquetas);
        $("#tab_comparativo_datos").html(html);
    }

    // Recalcula todas las metricas de todo el objeto de planificacion
    function actualizarPlanificacion(){
        $.each(planificacion.ventas, function(temporada, ventas) {
            $.each(ventas, function(periodo, venta) {
                if( venta.anio == (planificacion.temporada_vigente['anio']) ){
                    // Costo unitario               
                    venta.costo_u = planificacion.itemplan.costo_unitario
                    
                    // Venta Neta
                    venta.vta_n = parseFloat( (1 - venta.dcto) * venta.vta_u * planificacion.itemplan.precio / 1.19 );
                        
                    // Contribucion
                    venta.ctb_n = parseFloat(venta.vta_n - (venta.vta_u * venta.costo_u)).toFixed(1);
                    
                    // Margen                   
                    if(venta.vta_n != 0)
                        venta.margen = venta.ctb_n / venta.vta_n;

                    // Precio Real
                    if(venta.vta_n != 0)
                        venta.precio_real = venta.vta_n / venta.vta_u * 1.19;
                }
            });
        });
        tablaDctoUni(planificacion);
    }

    // Recalcula las principales metricas un periodo del objeto de planificacion
    function actualizarPerPlanificacion(metrica, periodo, temporada){
        // Si se proyectaron las unidades, se entra al ciclo if
        if(metrica == 'unidades'){
            $.each(planificacion.ventas[temporada], function(periodo_venta, venta) {
                if((venta.anio + "" + venta.periodo) == periodo.trim()){
                    // Se asigna tipo temporal 3 (modificada no guardada)
                    venta.tipo = 3;
                    // Se lee el valor de la celda y se quita su formato
                    venta.vta_u = numeral().unformat(td.text());

                    // Venta Neta
                    venta.vta_n = parseFloat( (1 - venta.dcto) * venta.vta_u * planificacion.itemplan.precio / 1.19 );
                    
                    // Contribucion
                    venta.ctb_n = parseFloat(venta.vta_n - (venta.vta_u * venta.costo_u)).toFixed(1);
                    
                    // Margen                   
                    if(venta.vta_n != 0)
                        venta.margen = venta.ctb_n / venta.vta_n;

                    // Precio Real
                    if(venta.vta_n != 0)
                        venta.precio_real = venta.vta_n / venta.vta_u * 1.19;

                    tablaDctoUni(planificacion);
                    return false;
                }
            });
        }
        // Si se proyectaron los descuentos, se entra al ciclo if
        else if(metrica == 'descuentos'){
            $.each(planificacion.ventas[temporada], function(periodo_venta, venta) {
                if((venta.anio + "" + venta.periodo) == periodo.trim()){
                    // Se asigna tipo temporal 3 (modificada no guardada)
                    venta.tipo = 3;
                    
                    // Se lee el valor de su celda y se quita su formato
                    venta.dcto = numeral().unformat(td.text());
                    
                    // Venta Neta
                    venta.vta_n = parseFloat( (1 - venta.dcto) * venta.vta_u * planificacion.itemplan.precio / 1.19 );
                    
                    // Contribucion
                    venta.ctb_n = parseFloat(venta.vta_n - (venta.vta_u * venta.costo_u)).toFixed(1);
                    
                    // Margen                   
                    if(venta.vta_n != 0)
                        venta.margen = venta.ctb_n / venta.vta_n;

                    // Precio Real
                    if(venta.vta_n != 0)
                        venta.precio_real = venta.vta_n / venta.vta_u * 1.19;

                    tablaDctoUni(planificacion);
                    return false;
                }
            });
        }
        // Si se planifico el costo unitario, se entra al ciclo if
        else if(metrica == 'costos'){
            $.each(planificacion.ventas[temporada], function(periodo_venta, venta) {
                if((venta.anio + "" + venta.periodo) == periodo.trim()){
                    // Se asigna tipo temporal 3 (modificada no guardada)
                    venta.tipo = 3;
                    // Se lee el valor de la celda y se quita su formato
                    venta.costo_u = numeral().unformat(td.text());
                    
                    // Venta Neta
                    venta.vta_n = parseFloat( (1 - venta.dcto) * venta.vta_u * planificacion.itemplan.precio / 1.19 );
                    
                    // Contribucion
                    venta.ctb_n = parseFloat(venta.vta_n - (venta.vta_u * venta.costo_u)).toFixed(1);
                    
                    // Margen                   
                    if(venta.vta_n != 0)
                        venta.margen = venta.ctb_n / venta.vta_n;

                    // Precio Real
                    if(venta.vta_n != 0)
                        venta.precio_real = venta.vta_n / venta.vta_u * 1.19;

                    tablaDctoUni(planificacion);
                    return false;
                }
            });
        }
    }

    function tablaProyeccion(data){

        var html_tot_vta_n = "";
        var html_tot_ctb_n = "";
        var html_tot_margen = "";
        var html_tot_unidades = "";
        var html = "";        
        html += "<table class=\"datagrid\" style=\"width:100%;\">";
        html += "<thead>";
        html += "<tr>";
        html += "<th style=\"width:16%;\">Temporada</th>";
        for (var x=0; x<data.periodos.length; x++){
            if (data.periodos[x].temporada){
                html += "<th title=\"Periodo de la temporada " 
                    + data.temporada_vigente.nombre + " - " 
                    + (parseInt(data.temporada_vigente.anio) - 1)  
                    + "\" style=\"width:7%;background-color:#669;color:white\">" 
                    + data.periodos[x].nombre + "</th>";
            }
            else
                html += "<th>" + data.periodos[x].nombre + "</th>";
        }
        html += "</tr>";
        html += "</thead>";
        html += "<tbody>";
        
        /* Se itera por cada temporada */
        $.each(data.ventas, function(temporada, ventas) {
            html += "<tr>";
            html += "<td class=\"separador\" colspan=\"13\"><b>Temporada: " + temporada + "</b></td>";
            html += "</tr>";

            /* Unidades vendidas */
            html += "<tr>";
            html += "<td title=\"Unidades vendidas.\" style=\"width:16%;\">Unidades</td>";
            $.each(ventas, function(periodo, venta) {
                if(venta.tipo != 0)
                    html += "<td id=\"unidades_" + venta.periodo + "_" + temporada + "\" class=\"par unidades editable plan\">" + numeral(venta.vta_u).format('0,0') + "</td>";
                else
                    html += "<td class=\"par unidades\">" + numeral(venta.vta_u).format('0,0') + "</td>";

            });
            html += "</tr>";
            
             /* Descuentos */
            html += "<tr>";
            html += "<td title=\"Descuento sobre el precio blanco.\" style=\"width:16%;\">Descuento %</td>";
            $.each(ventas, function(periodo, venta) {
                if(venta.tipo != 0)
                    html += "<td id=\"descuentos_" + venta.periodo + "_" + temporada + "\" class=\"par descuentos editable plan\">" + numeral(venta.dcto).format('0.00%') + "</td>";
                else
                    html += "<td class=\"par descuentos\">" + numeral(venta.dcto).format('0.00%') + "</td>";
            });
            html += "</tr>";

            /* Precio Real */
            html += "<tr>";
            html += "<td title=\"Precio real de venta.\" style=\"width:16%;\">Precio Real</td>";
            $.each(ventas, function(periodo, venta) {
                html += "<td class=\"par\">" + numeral(venta.precio_real).format('0,0') + "</td>";
            });
            html += "</tr>";

            /* Venta neta */
            html += "<tr>";
            html += "<td title=\"Venta en pesos.\" style=\"width:16%;\">Venta</td>";
            $.each(ventas, function(periodo, venta) {
                html += "<td class=\"par\">" + numeral(venta.vta_n).format('0,0') + "</td>";    
            });
            html += "</tr>";
            
             /* Contribucion */
            html += "<tr>";
            html += "<td title=\"Contribucion en pesos.\" style=\"width:16%;\">Contribuci&oacute;n</td>";
            $.each(ventas, function(periodo, venta) {
                html += "<td class=\"par\">" + numeral(venta.ctb_n).format('0,0') + "</td>";
            });
            html += "</tr>";
            
            /* Margen */
            html += "<tr>";
            html += "<td title=\"Margen porcentual.\" style=\"width:16%;\">Margen %</td>";
            $.each(ventas, function(periodo, venta) {
                html += "<td class=\"par\">" + numeral(venta.margen).format('0.00%') + "</td>";
            });
            html += "</tr>";

        });
        
        /* Totales */
        html += "<tr>";
        html += "<td class=\"separador\" colspan=\"13\"><b>Totales:</b></td>";
        html += "</tr>";
        for (var x=0; x<data.periodos.length; x++){
            var total_unidades = 0;
            var total_vta_n = 0;
            var total_ctb_n = 0;
            var total_margen = 0;
            $.each(data.ventas, function(temporada, ventas) {
                $.each(ventas, function(periodo, venta) {
                    if (periodo == data.periodos[x].nombre){
                        total_unidades += parseFloat(venta.vta_u);
                        total_vta_n += parseFloat(venta.vta_n);
                        total_ctb_n += parseFloat(venta.ctb_n);
                        return false;
                    }
                });

            });
            if (total_vta_n != 0)
                total_margen = total_ctb_n / total_vta_n;
            html_tot_unidades += "<td>" + numeral(total_unidades).format('0,0') + "</td>";
            html_tot_vta_n += "<td>" + numeral(total_vta_n).format('0,0') + "</td>";
            html_tot_ctb_n += "<td>" + numeral(total_ctb_n).format('0,0') + "</td>";
            html_tot_margen += "<td>" + numeral(total_margen).format('0.00%') + "</td>";
        }
        html += "<tr class=\"par totales\">";
        html += "<td title=\"Total unidades temporadas.\" style=\"width:16%;\">Unidades</td>";
        html += html_tot_unidades;
        html += "</tr>";
        html += "<tr class=\"par totales\">";
        html += "<td title=\"Total venta temporadas.\" style=\"width:16%;\">Venta</td>";
        html += html_tot_vta_n;
        html += "</tr>";
        html += "<tr class=\"par totales\">";
        html += "<td title=\"Total contribuci&oacute;n.\" style=\"width:16%;\">Contribuci&oacute;n</td>";
        html += html_tot_ctb_n;
        html += "</tr>";
        html += "<tr class=\"par totales\">";
        html += "<td title=\"Total margen.\" style=\"width:16%;\">Margen</td>";
        html += html_tot_margen;
        html += "</tr>";
        html += "</tbody>";
        html += "</table>";
        $("#contenedor-dialog-proyeccion").html(html);
        //$('#mydiv .myclass');
        $("#contenedor-dialog-proyeccion .editable").click(proyectar);
        $( "#dialog-proyeccion" ).dialog( "open" );
    }

    /*
        Abre el dialog que permite modificar un valor de unidades o descuento de una proyeccion
    */
    function proyectar(){
        // Se asigna a td la celda que ha sido presionada para proyectar su valor
        td = $(this);
        // Se hace un split sobre el id de la celda para obtener el tipo de celda (unidad o dcto), periodo y temporada
        parametros = td.attr("id").split("_");
        // Se agrega el valor de la celda al input box del dialog
        $("#inputvalproy").val(td.text());
        // Se customiza el mensaje del dialog en base al tipo de celda que se esta proyectando
        if(parametros[0] == 'unidades')
            $("#dialog_proy_help_msg").text("Ingresar unidades:");
        else
            $("#dialog_proy_help_msg").text("Ingresar porcentaje (0%-100%):");
        $( "#dialog-box-proyeccion" ).dialog( "open" );
        $( "#dialog-box-proyeccion input[type=text]" ).select();
    }

    /*
        Actualiza el objeto de proyeccion al ajustar un proyeccion
    */
    function actualizarProyeccion(metrica, periodo, temporada){
        // Si se proyectaron las unidades, se entra al ciclo if
        var proyeccion = obj_planificacion.getDataProyeccion();
        if(metrica == 'unidades'){
            $.each(proyeccion.ventas[temporada], function(periodo_venta, venta) {
                if(periodo_venta == periodo.trim()){
                    // Se asigna tipo temporal 3 (proyectada no guardada)
                    venta.tipo = 3;
                    // Se lee el valor de la celda y se quita su formato
                    venta.vta_u = numeral().unformat(td.text());

                    // Venta Neta
                    venta.vta_n = parseFloat( (1 - venta.dcto) * venta.vta_u * proyeccion.itemplan.precio / 1.19 );
                    
                    // Contribucion
                    venta.ctb_n = parseFloat(venta.vta_n - (venta.vta_u * proyeccion['itemplan'].costo_unitario)).toFixed(1);
                    
                    // Margen                   
                    if(venta.vta_n != 0)
                        venta.margen = venta.ctb_n / venta.vta_n;

                    // Precio Real
                    if(venta.vta_n != 0)
                        venta.precio_real = venta.vta_n / venta.vta_u * 1.19;

                    // Costo
                    venta.costo = parseFloat(venta.vta_u * proyeccion['itemplan'].costo_unitario).toFixed(1);

                    obj_planificacion.setDataProyeccion(proyeccion);
                    tablaProyeccion(proyeccion);
                    return false;
                }
            });
        }
        // Si se proyectaron los descuentos, se entra al ciclo if
        else if(metrica == 'descuentos'){
            $.each(proyeccion.ventas[temporada], function(periodo_venta, venta) {
                if(periodo_venta == periodo.trim()){
                    // Se asigna tipo temporal 3 (proyectada no guardada)
                    venta.tipo = 3;
                    // Se lee el valor de la celda y se quita su formato
                    venta.dcto = numeral().unformat(td.text());
                    
                    // Venta Neta
                    venta.vta_n = parseFloat( (1 - venta.dcto) * venta.vta_u * proyeccion.itemplan.precio / 1.19 );
                    
                    // Contribucion
                    venta.ctb_n = parseFloat(venta.vta_n - (venta.vta_u * proyeccion['itemplan'].costo_unitario)).toFixed(1);
                    
                    // Margen                   
                    if(venta.vta_n != 0)
                        venta.margen = venta.ctb_n / venta.vta_n;

                    // Precio Real
                    if(venta.vta_n != 0)
                        venta.precio_real = venta.vta_n / venta.vta_u * 1.19;

                    obj_planificacion.setDataProyeccion(proyeccion);
                    tablaProyeccion(proyeccion);
                    return false;
                }
            });
        }
    }

    /*
    Gatilla un request AJAX y devuelve un response JSON con la informacion
    que despliegan los graficos
    */

    function buscarResumen(){
        var id_temporada_id, id_plan, id_item;
        id_item = obj_planificacion.getItem();
        id_plan = obj_planificacion.getPlan();
        id_temporada = -2;
        if (id_temporada != -1 && (id_item)) {
            $.ajax({
                data: {'id_plan':id_plan, 'id_temporada':id_temporada, 'id_item':id_item},
                url: '/planes/plan/resumendata/',
                type: 'get',
                dataType:'json',
                success: function(data){
                    console.log(data);
                    $("#dashboard").show();

                    var data_unidades = data.estadisticas.unidades;
                    var data_venta = data.estadisticas.venta;
                    var data_contribucion = data.estadisticas.contribucion;
                    var data_margen = data.estadisticas.margen;
                    var data_costo = data.estadisticas.costo;
                    var data_dcto_precio = data.estadisticas.dcto_precio;

                    var colores_arr = ['#44bbcc','#88dddd','#bbeeff'];
                    var color_linea_margen = ['#0055bb'];
                    var color_texto = '#777';
                    var tipo_letra = "Sans-Serif";
                    var tamano_letra = 10;

                    // Reset the canvas
                    RGraph.Reset(document.getElementById("venta-chart"));
                    RGraph.Reset(document.getElementById("unidades-chart"));
                    RGraph.Reset(document.getElementById("contribucion-chart"));
                    RGraph.Reset(document.getElementById("precio-chart"));

                    var bar_venta = new RGraph.Bar('venta-chart', data_venta.rows)
                        .Set('text.color', color_texto)
                        //.Set('text.font', tipo_letra)
                        .Set('labels', data_venta.cols)
                        .Set('labels.above', true)
                        .Set('labels.above.size', tamano_letra)
                        .Set('colors', colores_arr)
                        .Set('ylabels', false)
                        .Set('noyaxis', true)
                        .Set('gutter.left', 10)
                        .Set('gutter.right', 10)
                        .Set('gutter.bottom', 60)
                        .Set('background.grid', false)
                        .Set('labels.ingraph', data_venta.ingraph)
                        .Draw();

                    var bar_unidades = new RGraph.Bar('unidades-chart', data_unidades.rows)
                        .Set('text.color', color_texto)
                        .Set('labels', data_unidades.cols)
                        .Set('labels.above', true)
                        .Set('labels.above.size', tamano_letra)
                        .Set('colors', colores_arr)
                        .Set('ylabels', false)
                        .Set('noyaxis', true)
                        .Set('gutter.left', 10)
                        .Set('gutter.right', 10)
                        .Set('gutter.bottom', 60)
                        .Set('background.grid', false)
                        .Set('labels.ingraph', data_unidades.ingraph)
                        .Draw();

                    var bar_contribucion = new RGraph.Bar('contribucion-chart', data_contribucion.rows)
                        .Set('text.color', color_texto)
                        .Set('tooltips', data_contribucion.tooltips)
                        .Set('tooltips.event','onmousemove')
                        .Set('labels', data_contribucion.cols)
                        .Set('labels.above', true)
                        .Set('labels.above.size', tamano_letra)
                        .Set('colors', colores_arr)
                        .Set('ylabels', false)
                        .Set('noyaxis', true)
                        .Set('gutter.left', 10)
                        .Set('gutter.right', 10)
                        .Set('gutter.bottom', 60)
                        .Set('background.grid', false)
                        .Set('labels.ingraph', data_contribucion.ingraph)

                    var line_margen = new RGraph.Line('contribucion-chart', data_margen.rows)
                        .Set('tooltips', data_margen.tooltips)
                        .Set('tooltips.hotspot.size', 20)
                        .Set('colors', color_linea_margen)
                        .Set('tickmarks', 'circle')
                        .Set('ylabels', false)
                        .Set('noyaxis', true)
                        .Set('linewidth', 2)
                        .Set('units.post', '%')
                        .Set('gutter.left', 10)
                        .Set('gutter.right', 10)
                        .Set('gutter.bottom', 60)   
                        .Set('background.grid', false)
                        .Set('outofbounds', true) // Para valores negativos
                    var combo = new RGraph.CombinedChart(bar_contribucion, line_margen);
                    combo.Draw();

                    var bar_precio_dcto = new RGraph.Bar('precio-chart', data_dcto_precio.rows)
                        .Set('text.color', color_texto)
                        .Set('colors', colores_arr)
                        .Set('labels', data_dcto_precio.cols)
                        .Set('labels.above', true)
                        .Set('labels.above.size', tamano_letra)
                        .Set('grouping', 'stacked')
                        .Set('noyaxis', true)
                        .Set('gutter.left', 10)
                        .Set('gutter.right', 10)
                        .Set('gutter.bottom', 60)
                        .Set('background.grid', false)
                        .Set('ylabels', false)
                        .Set('linewidth', 2)
                        .Set('strokestyle', 'white')
                        .Draw();

                    // Esta funcion se utiliza para unificar los pedazos de cada barra, con el objetivo de que
                    // los tooltips se muestren al pasar el mouse sobre cualquiera de ellos
                    RGraph.each (bar_precio_dcto.coords2, function (key, value)
                    {
                        var x = value[0][0];
                        var y = value[0][1];
                        var w = value[0][2];
                        var h = value[0][3] + value[1][3] + value[2][3]; // Sum up the heights of the bar segments

                        var rect = new RGraph.Drawing.Rect('precio-chart', x, y, w, h)
                            .Set('strokestyle', 'rgba(0,0,0,0)')
                            .Set('fillstyle', 'rgba(0,0,0,0)')
                            .Set('tooltips', [data_dcto_precio.tooltips[key]])
                            .Set('tooltips.event','onmousemove')
                            .Set('highlight.stroke', 'rgba(0,0,0,0)')
                            .Draw();
                    }, bar_precio_dcto);

                    var bar_costo = new RGraph.Bar('precio-chart', data_costo.rows)
                        .Set('text.color', color_texto)
                        .Set('ymax', bar_precio_dcto.scale2.max)
                        .Set('gutter.left', bar_precio_dcto.Get('gutter.left'))
                        .Set('colors', color_linea_margen)
                        .Set('noaxes', true)
                        .Set('labels.above', true)
                        .Set('labels.above.size', tamano_letra)
                        .Set('hmargin', 20)
                        .Set('ylabels', false)
                        .Set('noyaxis', true)
                        .Set('gutter.left', 10)
                        .Set('gutter.right', 10)
                        .Set('gutter.bottom', 60)
                        .Set('background.grid', false)
                        .Draw();
                    $( "#dialog-resumen" ).dialog( "open" );
                },
                complete: function(data){
                }
            });
        }
    }

    var respuestaMsgAjax = function(data){
        $("#barra_notificaciones")
            .html(data.msg)
            .addClass("msg_success")
            .delay(5000)
            .queue( function(next){ 
                $(this).removeClass("msg_success");
                $(this).html("");
                    next(); 
        });
    };

    $("#combo_resultado").change(buscarTablaPlanificacionAJAX);
    $("[id^=button_cat_comp_]").click(function(){
        var id_item;
        var id_this = $(this).attr("id");
        // Se divide el ID del elemento BUTTON para generar el ID del elemento SELECT asociado
        // El cuarto valor del array es el ID asociado que se busca ya que el ID del elemento sigue la forma button_cat_comp_X
        id_button_array = id_this.split("_");
        id_item = $("#combo_cat_comp_" + id_button_array[3]).val();
        if ( id_item == -1 ){
            alert("Seleccione una opci贸n v谩lida.");
            return 0;
        }
        buscarTablaComparacionAJAX_par(id_item);
    });
    $("[id^=combo_cat_plan_]").change(buscarCategoriaPlanificacion);
    $("[id^=combo_cat_comp_]").change(buscarCategoriaComparacion);
    $("#btnProyeccion").click(buscarTablaProyeccionAJAX);
    $("#btnResumen").click(buscarResumen);
    buscarEstadisticasPlan();
});
</script>
{% endblock %}